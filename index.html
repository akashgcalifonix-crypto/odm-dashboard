<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Landscape Defect Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <!-- LIBRARIES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f0f2f5; color: #333; }
    .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 1200px; margin: auto; }
    
    /* --- HEADER & TABS --- */
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .app-logo { height: 50px; object-fit: contain; }
    
    .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .tab-btn { background: none; border: none; padding: 10px 20px; font-size: 15px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: #0369a1; border-bottom-color: #0369a1; background: #f9fbfd; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- FORM --- */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { font-weight: 600; font-size: 12px; color: #555; display: block; margin-bottom: 5px; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background: #fafafa; }
    input:focus, textarea:focus { border-color: #0369a1; outline: none; background: #fff; }
    
    /* --- BUTTONS --- */
    .btn { background: #0369a1; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { background: #025686; transform: translateY(-1px); }
    .btn.secondary { background: #6b7280; }
    .btn.danger { background: #dc3545; }
    .btn.ppt { background: #D24726; } 
    .btn.excel { background: #217346; }
    .btn.success { background: #28a745; }

    /* --- DATA TABLE --- */
    table.data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; font-size: 13px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .data-table th { background: #0369a1; color: white; padding: 12px; text-align: left; text-transform: uppercase; font-size: 11px; }
    .data-table td { border-bottom: 1px solid #eee; padding: 12px; }
    .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }

    /* --- PREVIEW MODAL (LANDSCAPE) --- */
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-content { background:white; width: 95%; max-width: 1300px; height: 90vh; display: flex; flex-direction: column; border-radius: 6px; overflow: hidden; }
    .modal-header { padding: 15px; background: #f1f1f1; border-bottom: 1px solid #ccc; display:flex; justify-content:space-between; align-items:center; }
    .modal-body { flex: 1; overflow-y: auto; background: #333; padding: 40px; display: flex; justify-content: center; align-items: flex-start; }

    /* ========================================= */
    /* === LANDSCAPE REPORT DESIGN (CSS) === */
    /* ========================================= */
    .report-slide {
        background: white;
        width: 1000px;  /* Fixed width to simulate 16:9 slide */
        height: 562px; /* Fixed height to simulate 16:9 slide */
        padding: 30px;
        box-sizing: border-box;
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
        font-family: 'Segoe UI', Arial, sans-serif;
        position: relative;
        display: flex;
        flex-direction: column;
        margin-bottom: 40px; /* Space between slides in preview */
    }

    /* Header */
    .rep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #0369a1; padding-bottom: 10px; margin-bottom: 15px; height: 60px; }
    .rep-logo { height: 50px; object-fit: contain; }
    .rep-title h1 { color: #0369a1; font-size: 22px; margin: 0; text-transform: uppercase; font-weight: 800; text-align: right; }
    .rep-title p { color: #666; font-size: 11px; margin: 0; text-align: right; }

    /* Info Bar (Horizontal) */
    .rep-info-bar { 
        display: flex; gap: 15px; background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-bottom: 20px; 
        justify-content: space-between;
    }
    .info-item { display: flex; flex-direction: column; font-size: 11px; }
    .info-item span:first-child { font-weight: bold; color: #666; margin-bottom: 2px; text-transform: uppercase; }
    .info-item span:last-child { font-weight: bold; color: #000; font-size: 13px; }

    /* Main Layout (Split) */
    .rep-body { display: flex; gap: 25px; flex: 1; overflow: hidden; }
    
    /* Left Column (Text) */
    .rep-left { flex: 2; display: flex; flex-direction: column; gap: 15px; }
    
    /* Right Column (Visuals) */
    .rep-right { flex: 1; display: flex; flex-direction: column; gap: 15px; }

    /* Sections */
    .rep-sec-head {
        background: #eef6fb;
        border-left: 4px solid #0369a1;
        padding: 6px 10px;
        font-weight: 700;
        color: #005a8d;
        font-size: 13px;
        margin-bottom: 8px;
    }
    .rep-text-box {
        font-size: 12px;
        line-height: 1.5;
        color: #333;
        background: #fff;
        height: 100%;
    }

    /* Rate Box */
    .rep-rate-card {
        background: #0369a1;
        color: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .rep-rate-lbl { font-size: 10px; text-transform: uppercase; opacity: 0.9; letter-spacing: 1px; }
    .rep-rate-val { font-size: 36px; font-weight: 800; line-height: 1.1; margin-top: 5px; }

    /* Images */
    .rep-img-box {
        flex: 1;
        background: #f9f9f9;
        border: 1px dashed #ccc;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    .rep-img { max-width: 100%; max-height: 100%; object-fit: contain; }

  </style>
</head>

<body>

<div class="card">
  <div class="header-row">
      <h2 style="color:#0369a1; margin:0;">Incoming Rejection Tracker</h2>
      <img id="mainLogo" src="https://i.postimg.cc/5y7SN4xc/logo.png" class="app-logo" crossorigin="anonymous" alt="Logo">
  </div>

  <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('entry')">Daily Entry</button>
      <button class="tab-btn" onclick="switchTab('report')">Monthly Report (Landscape)</button>
  </div>

  <!-- ENTRY TAB -->
  <div id="entryTab" class="tab-content active">
      <input type="hidden" id="editRowIndex">
      <div class="form-grid">
          <div><label>Date</label><input id="date" type="date"></div>
          <div><label>ODM Name</label><input id="odm" placeholder="e.g. Glanto"></div>
          <div><label>Model No.</label><input id="model" placeholder="e.g. AD 311 Pro"></div>
          <div><label>PO Number</label><input id="po" placeholder="e.g. 42724692"></div>
      </div>
      <div class="form-grid">
          <div><label>Item Name</label><input id="item" placeholder="e.g. Back cover"></div>
          <div><label>Defect Rate %</label><input id="defectRate" type="number" step="0.01" placeholder="%"></div>
          <div><label>Prepared By</label><input id="preparedBy" placeholder="e.g. Vijay"></div>
          <div><label>Images (Max 2)</label><input id="images" type="file" accept="image/*" multiple></div>
      </div>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div><label>Defect Description & Observation</label><textarea id="defectDetails" rows="3"></textarea></div>
          <div><label>Root Cause Analysis (RCA)</label><textarea id="rca" rows="3"></textarea></div>
      </div>
      <div style="margin-top:20px;">
          <button id="saveBtn" type="button" class="btn">Save Record</button>
          <button id="clearBtn" type="button" class="btn secondary">Clear Form</button>
          <button id="refreshBtn" type="button" class="btn secondary" style="float:right">Refresh List</button>
      </div>
      <table id="dataTable" class="data-table">
        <thead><tr><th>Date</th><th>Model</th><th>Defect</th><th>Rate%</th><th>Image</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
  </div>

  <!-- REPORT TAB -->
  <div id="reportTab" class="tab-content">
      <div class="card" style="background:#f8f9fa; border:1px solid #eee;">
          <div style="display:flex; gap:15px; align-items:end;">
              <div style="flex:1;">
                  <label>Select Month for Report</label>
                  <input type="month" id="reportMonthInput">
              </div>
              <button class="btn" onclick="generatePreview()">üîç Preview Landscape Slides</button>
          </div>
      </div>

      <div id="reportActions" style="display:none; justify-content: flex-end; gap:10px; margin-top:20px;">
          <button id="btnPPT" class="btn ppt">üìä Download PPT (Landscape)</button>
          <button id="btnPDF" class="btn success">‚¨á Download PDF</button>
      </div>

      <div id="previewContainer" style="margin-top:20px; overflow-x: auto; text-align: center;">
          <!-- Preview slides will appear here -->
      </div>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">üìÑ Landscape Report Preview</h3>
            <button onclick="closeModal()" style="border:none;background:none;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modalContent"></div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGCDn3USDWCByX5a-rgiZDkX-YwdfH4y1bd6_PgpLs-ZXgLo9FG5eboPSt4zKI8TfEcA/exec"; 
const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png";

let allData = [];
let currentReportData = [];
let base64Logo = "";

// Pre-load Logo safely
function convertLogoToBase64() {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.onload = function(){
        const c = document.createElement('canvas');
        c.width = img.width; c.height = img.height;
        c.getContext('2d').drawImage(img, 0, 0);
        base64Logo = c.toDataURL('image/png');
    };
    img.src = LOGO_URL;
}

function readFilesAndCompress(files) {
  return Promise.all([...files].map(file => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        let w = img.width, h = img.height;
        if(w > 800) { h *= 800/w; w = 800; }
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', 0.7));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  })));
}

// --- CRUD ACTIONS ---
async function saveRecord(){
    const btn = document.getElementById('saveBtn');
    
    // VALIDATION
    if(!document.getElementById('odm').value || !document.getElementById('model').value){
        alert("Please fill in ODM and Model Name");
        return;
    }

    btn.innerText="Saving..."; btn.disabled=true;
    
    try {
        let imgs = [];
        const files = document.getElementById('images').files;
        if(files.length) imgs = await readFilesAndCompress(files);

        const rid = document.getElementById('editRowIndex').value;
        
        // KEEP OLD IMAGES IF EDITING
        if(rid && !imgs.length){
            let old = allData.find(x=>x._rowIndex==rid);
            if(old && old.ImageURLs) imgs = old.ImageURLs.split(" || ");
        }

        const rec = {
            date: document.getElementById('date').value,
            odm: document.getElementById('odm').value,
            model: document.getElementById('model').value,
            po: document.getElementById('po').value,
            item: document.getElementById('item').value,
            defectDetails: document.getElementById('defectDetails').value,
            defectRate: document.getElementById('defectRate').value,
            rca: document.getElementById('rca').value,
            preparedBy: document.getElementById('preparedBy').value,
            images: imgs
        };

        let res = await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify({ action:rid?"update":"create", record:rec, rowIndex:rid }) });
        let j = await res.json();
        
        if(j.status==="success"){ 
            alert("‚úÖ Saved Successfully!"); 
            clearForm(); 
            loadData(); 
        } else { 
            alert("Error: "+j.message); 
        }
    } catch(e){
        console.error(e); 
        alert("Connection Error. Check SCRIPT_URL or Internet.");
    }
    
    btn.innerText="Save Record"; btn.disabled=false;
}

async function deleteRec(id) {
    if(!confirm("Delete this record?")) return;
    try {
        await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify({ action:"delete", rowIndex:id }) });
        alert("Deleted!"); loadData();
    } catch(e) { alert("Delete failed"); }
}

function editRec(id){
    let r = allData.find(x=>x._rowIndex==id);
    if(!r) return;
    
    // Populate Form
    document.getElementById('date').value = r.Date.replace("'","");
    document.getElementById('odm').value = r.ODM;
    document.getElementById('model').value = r.Model;
    document.getElementById('po').value = r.PO;
    document.getElementById('item').value = r.Item;
    document.getElementById('defectDetails').value = r.DefectDetails;
    document.getElementById('defectRate').value = r.DefectRate;
    document.getElementById('rca').value = r.RCA;
    document.getElementById('preparedBy').value = r.PreparedBy;
    
    // Set Hidden Index & Button Text
    document.getElementById('editRowIndex').value = id;
    document.getElementById('saveBtn').innerText="Update Record";
    
    switchTab('entry');
    window.scrollTo(0,0);
}

function clearForm(){
    document.querySelectorAll('#entryTab input, #entryTab textarea').forEach(e=>e.value="");
    document.getElementById('editRowIndex').value="";
    document.getElementById('saveBtn').innerText="Save Record";
}

async function loadData(){
    const tb = document.querySelector("#dataTable tbody");
    if(!tb) return;
    tb.innerHTML="<tr><td colspan='6' align='center'>Loading...</td></tr>";
    try{
        let res = await fetch(SCRIPT_URL);
        let j = await res.json();
        allData = j.rows;
        renderTable(allData);
    }catch(e){ tb.innerHTML="<tr><td colspan='6'>Error loading data</td></tr>"; }
}

function renderTable(rows){
    const tb = document.querySelector("#dataTable tbody");
    tb.innerHTML="";
    if(!rows || rows.length === 0) { tb.innerHTML="<tr><td colspan='6'>No Data</td></tr>"; return; }
    
    rows.forEach(r=>{
        let img = (r.ImageURLs||"").split(" || ")[0];
        let thumb = img ? `<img src="${img}" class="thumb">` : "";
        let tr = document.createElement("tr");
        
        tr.innerHTML=`
            <td>${r.Date.replace("'","")}</td>
            <td>${r.Model}</td>
            <td>${r.DefectDetails.substring(0,30)}...</td>
            <td style="color:${r.DefectRate>5?'red':'green'}">${r.DefectRate}%</td>
            <td>${thumb}</td>
            <td style="white-space:nowrap;">
                <button class="btn secondary" style="padding:4px 8px;" onclick="previewSingle(${r._rowIndex})">üëÅÔ∏è</button>
                <button class="btn secondary" style="padding:4px 8px;" onclick="editRec(${r._rowIndex})">‚úèÔ∏è</button>
                <button class="btn danger" style="padding:4px 8px;" onclick="deleteRec(${r._rowIndex})">üóëÔ∏è</button>
            </td>`;
        tb.appendChild(tr);
    });
}

// --- LANDSCAPE HTML GENERATOR ---
function generateSlideHTML(r) {
    let imgs = (r.ImageURLs||"").split(" || ").filter(Boolean);
    let img1 = imgs[0] ? `<img src="${imgs[0]}" crossorigin="anonymous" class="rep-img">` : '<span style="color:#ccc; font-size:12px;">No Image</span>';
    let img2 = imgs[1] ? `<img src="${imgs[1]}" crossorigin="anonymous" class="rep-img">` : '';

    return `
    <div class="report-slide">
        <!-- HEADER -->
        <div class="rep-header">
            <img src="${base64Logo || LOGO_URL}" class="rep-logo">
            <div class="rep-title">
                <h1>DEFECT ANALYSIS REPORT</h1>
                <p>Quality Assurance Dept.</p>
            </div>
        </div>

        <!-- INFO BAR -->
        <div class="rep-info-bar">
            <div class="info-item"><span>ODM Name</span><span>${r.ODM}</span></div>
            <div class="info-item"><span>Model No.</span><span>${r.Model}</span></div>
            <div class="info-item"><span>Item Name</span><span>${r.Item}</span></div>
            <div class="info-item"><span>PO Number</span><span>${r.PO}</span></div>
            <div class="info-item"><span>Report Date</span><span>${r.Date.replace("'","")}</span></div>
            <div class="info-item"><span>Prepared By</span><span>${r.PreparedBy}</span></div>
        </div>

        <!-- MAIN BODY (SPLIT) -->
        <div class="rep-body">
            <!-- LEFT (TEXT) -->
            <div class="rep-left">
                <div>
                    <div class="rep-sec-head">1. Defect Description & Observation</div>
                    <div class="rep-text-box">${r.DefectDetails}</div>
                </div>
                <div>
                    <div class="rep-sec-head">2. Root Cause Analysis (RCA)</div>
                    <div class="rep-text-box">${r.RCA}</div>
                </div>
            </div>

            <!-- RIGHT (VISUALS) -->
            <div class="rep-right">
                <!-- Rate Card -->
                <div class="rep-rate-card">
                    <div class="rep-rate-lbl">Defect Rate</div>
                    <div class="rep-rate-val">${r.DefectRate}%</div>
                </div>
                <!-- Images -->
                <div class="rep-img-box">${img1}</div>
                ${img2 ? `<div class="rep-img-box">${img2}</div>` : ''}
            </div>
        </div>
    </div>
    `;
}

// --- PREVIEW FUNCTIONS ---
function previewSingle(id) {
    let r = allData.find(x => x._rowIndex == id);
    if(!r) return;
    document.getElementById('modalContent').innerHTML = generateSlideHTML(r);
    document.getElementById('previewModal').style.display = 'flex';
}

function generatePreview() {
    const mInput = document.getElementById('reportMonthInput').value;
    if(!mInput) return alert("Select Month");
    const [yr, mo] = mInput.split('-');
    currentReportData = allData.filter(r => r.Date.replace("'","").startsWith(`${yr}-${mo}`));
    
    if(!currentReportData.length) {
        document.getElementById('previewContainer').innerHTML = "<h3 align='center'>No Data Found</h3>";
        document.getElementById('reportActions').style.display='none';
        return;
    }

    let html = `<div id="exportWrapper" style="display:flex; flex-direction:column; align-items:center;">`;
    currentReportData.forEach(r => html += generateSlideHTML(r));
    html += `</div>`;
    
    document.getElementById('previewContainer').innerHTML = html;
    document.getElementById('reportActions').style.display='flex';
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }

// --- DOWNLOAD FUNCTIONS ---

function downloadPDFReport(){
    const el = document.getElementById('exportWrapper');
    html2pdf().set({ 
        margin: 0, 
        filename:'Landscape_Report.pdf', 
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas:{ scale:2, useCORS: true }, 
        jsPDF:{ unit:'in', format:[13.33, 7.5], orientation:'landscape'} // Approx 16:9 ratio
    }).from(el).save();
}

async function downloadProfessionalPPT() {
    if(!currentReportData.length) return;
    const btn = document.getElementById('btnPPT');
    btn.innerText = "Processing...";
    
    try {
        let pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9'; // Landscape 10 x 5.625 inches

        // Define Master Slide
        pptx.defineSlideMaster({
            title: "MASTER",
            background: { color: "FFFFFF" }
        });

        // LOOP THROUGH DATA
        for(let r of currentReportData) {
            let slide = pptx.addSlide({ masterName: "MASTER" });

            // 1. HEADER (Full Width)
            // Logo (Left)
            if(base64Logo) slide.addImage({ data: base64Logo, x: 0.3, y: 0.2, w: 1.5, h: 0.6 });
            // Title (Right)
            slide.addText("DEFECT ANALYSIS REPORT", { x: 5.0, y: 0.2, w: 4.7, fontSize: 18, color: '0369a1', bold: true, align: 'right' });
            slide.addText("Quality Assurance Dept.", { x: 5.0, y: 0.5, w: 4.7, fontSize: 10, color: '666666', align: 'right' });
            // Blue Line
            slide.addShape(pptx.ShapeType.line, { x: 0.3, y: 0.9, w: 9.4, h: 0, line: { color: '0369a1', width: 2 } });

            // 2. INFO BAR (Top Row) - y: 1.1
            let yInfo = 1.1;
            let xPos = 0.3;
            
            // Helper to add info block
            let addInfo = (lbl, val, width) => {
                slide.addText(lbl, { x:xPos, y:yInfo, w:width, fontSize:9, color:'666666', bold:true });
                slide.addText(val, { x:xPos, y:yInfo+0.2, w:width, fontSize:11, color:'000000', bold:true });
                xPos += width + 0.2;
            };

            addInfo("ODM NAME", r.ODM, 1.2);
            addInfo("MODEL NO.", r.Model, 1.2);
            addInfo("ITEM NAME", r.Item, 1.2);
            addInfo("PO NUMBER", r.PO, 1.2);
            addInfo("REPORT DATE", r.Date.replace("'",""), 1.2);
            addInfo("PREPARED BY", r.PreparedBy, 1.2);

            // 3. LEFT COLUMN (TEXT) - x: 0.3, y: 1.8, w: 6.0
            // Desc
            slide.addShape(pptx.ShapeType.rect, { x: 0.3, y: 1.8, w: 6.0, h: 0.35, fill: { color: 'EEF6FB' } });
            slide.addShape(pptx.ShapeType.rect, { x: 0.3, y: 1.8, w: 0.05, h: 0.35, fill: { color: '0369a1' } });
            slide.addText("1. Defect Description & Observation", { x: 0.4, y: 1.8, w: 5.5, h: 0.35, fontSize: 11, color: '005a8d', bold: true, valign: 'middle' });
            slide.addText(r.DefectDetails || "N/A", { x: 0.3, y: 2.2, w: 6.0, h: 1.2, fontSize: 10, color: '333333', valign: 'top' });

            // RCA
            slide.addShape(pptx.ShapeType.rect, { x: 0.3, y: 3.6, w: 6.0, h: 0.35, fill: { color: 'EEF6FB' } });
            slide.addShape(pptx.ShapeType.rect, { x: 0.3, y: 3.6, w: 0.05, h: 0.35, fill: { color: '0369a1' } });
            slide.addText("2. Root Cause Analysis (RCA)", { x: 0.4, y: 3.6, w: 5.5, h: 0.35, fontSize: 11, color: '005a8d', bold: true, valign: 'middle' });
            slide.addText(r.RCA || "N/A", { x: 0.3, y: 4.0, w: 6.0, h: 1.2, fontSize: 10, color: '333333', valign: 'top' });

            // 4. RIGHT COLUMN (VISUALS) - x: 6.5, y: 1.8, w: 3.2
            // Defect Rate Box
            slide.addShape(pptx.ShapeType.rect, { x: 6.5, y: 1.8, w: 3.2, h: 1.0, fill: { color: '0369a1' }, rx: 5 });
            slide.addText("DEFECT RATE", { x: 6.5, y: 1.9, w: 3.2, fontSize: 10, color: 'FFFFFF', align: 'center' });
            slide.addText(r.DefectRate + "%", { x: 6.5, y: 2.2, w: 3.2, fontSize: 32, color: 'FFFFFF', bold: true, align: 'center' });

            // Images
            let imgs = (r.ImageURLs||"").split(" || ").filter(Boolean);
            let imgY = 3.0;
            
            // Only show max 2 images in this layout to fit
            for(let i=0; i<Math.min(imgs.length, 2); i++) {
                try {
                    // Safe Image Add
                    let imgOpt = { x: 6.5, y: imgY, w: 3.2, h: 2.2 };
                    if(imgs[i].startsWith("data:")) slide.addImage({ data: imgs[i], ...imgOpt });
                    else slide.addImage({ path: imgs[i], ...imgOpt });
                    imgY += 2.3; // Move down for next image
                } catch(e) { console.log("PPT Img Error"); }
            }
        }

        pptx.writeFile({ fileName: `Landscape_Report_${new Date().getTime()}.pptx` }).then(() => {
            btn.innerText = "‚úÖ Downloaded!";
            setTimeout(() => btn.innerText = "üìä Download PPT", 2000);
        });

    } catch(e) {
        alert("PPT Error: " + e.message);
        btn.innerText = "üìä Download PPT";
    }
}

function switchTab(t){
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
    document.getElementById(t+'Tab').classList.add('active');
    const btns = document.querySelectorAll('.tab-btn');
    if(t==='entry') btns[0].classList.add('active'); else btns[1].classList.add('active');
}

document.addEventListener('DOMContentLoaded', function() {
    convertLogoToBase64();
    loadData();
    document.getElementById('saveBtn').onclick = saveRecord;
    document.getElementById('clearBtn').onclick = clearForm;
    document.getElementById('refreshBtn').onclick = loadData;
    document.getElementById('btnPPT').onclick = downloadProfessionalPPT;
    document.getElementById('btnPDF').onclick = downloadPDFReport;
});
</script>
</body>
</html>
