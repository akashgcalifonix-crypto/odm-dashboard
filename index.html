<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Defect Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; background: #f7fafc; }
    .card { background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    input, textarea, button { padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box; }
    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #0369a1; color: white; }
    .btn { background: #0369a1; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
    .btn.secondary { background: #6b7280; }
    .thumb { width: 60px; height: 50px; border-radius: 5px; object-fit: cover; cursor: pointer; }
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; display:none; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
    .modal .box { background:white; padding:20px; border-radius:8px; max-width:90%; max-height:90%; text-align:center; }
  </style>
</head>

<body>

<div class="card">
  <h2>Defect Dashboard</h2>

  <label>Date</label>
  <input id="date" type="date">

  <label>ODM</label>
  <input id="odm">

  <label>Model</label>
  <input id="model">

  <div class="row">
    <div><label>PO</label><input id="po"></div>
    <div><label>Item</label><input id="item"></div>
  </div>

  <label>Defect Details</label>
  <textarea id="defectDetails"></textarea>

  <label>Defect Rate %</label>
  <input id="defectRate" type="number">

  <label>RCA</label>
  <input id="rca">

  <label>Remarks</label>
  <textarea id="remarks"></textarea>

  <label>Prepared By</label>
  <input id="preparedBy">

  <label>Images</label>
  <input id="images" type="file" accept="image/*" multiple>

  <button class="btn" id="saveBtn">Save (Online)</button>
  <button class="btn secondary" id="clearBtn">Clear</button>

  <button class="btn secondary" id="refreshBtn" style="margin-top:10px;">Refresh</button>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Date</th><th>ODM</th><th>Model</th><th>PO</th><th>Item</th>
        <th>Defect Details</th><th>Rate%</th><th>RCA</th><th>Remarks</th>
        <th>Prepared</th><th>Images</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- IMAGE PREVIEW MODAL -->
<div id="modal" class="modal">
  <div class="box">
    <h3>Image Preview</h3>
    <img id="modalImage" style="max-width:100%;border-radius:8px;">
    <br><br>
    <button class="btn" id="downloadPdfBtn">Download PDF</button>
    <button class="btn secondary" onclick="closeModal()">Close</button>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

const SCRIPT_URL =
 "https://script.google.com/macros/s/AKfycbxzSUli7P6SxV-X8tDKIImf1MIlN6BUy1Ma28vCpZqKeJlXXQPCuwBlfOplIsOmSnbFDA/exec";


// Escape text
function escapeHtml(s){
  if(!s) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// Read image files
function readFilesDataURLs(files){
  return Promise.all([...files].map(file => new Promise(res=>{
    let fr = new FileReader();
    fr.onload = ()=>res({name:file.name, dataUrl:fr.result});
    fr.readAsDataURL(file);
  })));
}

// Save or update
async function saveRecord(action="create", rowIndex=null){
  const imagesData = await readFilesDataURLs(images.files);

  const record = {
    date: date.value,
    odm: odm.value,
    model: model.value,
    po: po.value,
    item: item.value,
    defectDetails: defectDetails.value,
    defectRate: defectRate.value,
    rca: rca.value,
    remarks: remarks.value,
    preparedBy: preparedBy.value,
    images: imagesData
  };

  const payload = { action, record };
  if(action==="update") payload.rowIndex = rowIndex;

  const res = await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify(payload) });
  const j = await res.json();

  if(j.status==="success"){
    alert("Saved");
    clearForm();
    loadData();
  } else {
    alert("Failed: " + j.message);
  }
}

// Clear form
function clearForm(){
  ["date","odm","model","po","item","defectDetails","defectRate","rca","remarks","preparedBy"]
  .forEach(id=>document.getElementById(id).value="");
  images.value="";
  saveBtn.textContent="Save (Online)";
  saveBtn.onclick=()=>saveRecord("create");
}

// Render table
function renderTable(rows){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";

  rows.forEach(r=>{
    const imgs=(r.ImageURLs||"").split(";").map(x=>x.trim()).filter(Boolean);
    const imgHtml = imgs.length ? imgs.map(u=>`<img src="${u}" class="thumb" onclick="openPreview('${u}')">`).join("") : "-";

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(r.Date)}</td>
      <td>${escapeHtml(r.ODM)}</td>
      <td>${escapeHtml(r.Model)}</td>
      <td>${escapeHtml(r.PO)}</td>
      <td>${escapeHtml(r.Item)}</td>
      <td>${escapeHtml(r.DefectDetails)}</td>
      <td>${escapeHtml(r.DefectRate)}</td>
      <td>${escapeHtml(r.RCA)}</td>
      <td>${escapeHtml(r.Remarks)}</td>
      <td>${escapeHtml(r.PreparedBy)}</td>
      <td>${imgHtml}</td>
      <td>
        <button class="btn secondary" onclick="editRecord(${r._rowIndex})">Edit</button>
        <button class="btn" onclick="deleteRecord(${r._rowIndex})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Load data
async function loadData(){
  const res = await fetch(SCRIPT_URL);
  const j = await res.json();
  renderTable(j.rows);
}

// Edit record
async function editRecord(rowIndex){
  const res = await fetch(SCRIPT_URL);
  const j = await res.json();
  const r = j.rows.find(x=>x._rowIndex==rowIndex);

  date.value = r.Date;
  odm.value = r.ODM;
  model.value = r.Model;
  po.value = r.PO;
  item.value = r.Item;
  defectDetails.value = r.DefectDetails;
  defectRate.value = r.DefectRate;
  rca.value = r.RCA;
  remarks.value = r.Remarks;
  preparedBy.value = r.PreparedBy;

  saveBtn.textContent="Update";
  saveBtn.onclick=()=>saveRecord("update", rowIndex);
}

// Delete record
async function deleteRecord(rowIndex){
  if(!confirm("Delete?")) return;

  const res = await fetch(SCRIPT_URL, {
    method:"POST",
    body:JSON.stringify({action:"delete", rowIndex})
  });

  const j = await res.json();
  if(j.status==="success"){
    alert("Deleted");
    loadData();
  }
}


// Image Preview Modal
function openPreview(url){
  modalImage.src = url;
  modal.style.display = "flex";

  downloadPdfBtn.onclick = ()=> downloadPDF(url);
}

function closeModal(){
  modal.style.display = "none";
}

// Download PDF
function downloadPDF(imgUrl){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  let img = new Image();
  img.src = imgUrl;

  img.onload = function(){
    pdf.addImage(img, "JPEG", 10, 10, 180, 150);
    pdf.save("Image.pdf");
  };
}

// Event listeners
saveBtn.onclick = ()=>saveRecord("create");
clearBtn.onclick = clearForm;
refreshBtn.onclick = loadData;

loadData();

</script>

</body>
</html>
