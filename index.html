<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Incoming Rejection Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <!-- LIBRARIES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1100px; margin: auto; }
    
    /* TABS */
    .tab-nav { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab-btn { background: none; border: none; padding: 12px 25px; font-size: 15px; font-weight: bold; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-btn.active { color: #0369a1; border-bottom-color: #0369a1; background: #f8fbff; }
    .tab-content { display: none; animation: fadeIn 0.4s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* HEADER */
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .header-row h2 { color: #0369a1; margin: 0; font-size: 24px; }
    .app-logo { height: 50px; object-fit: contain; }

    /* FORM & BUTTONS */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { font-weight: bold; font-size: 12px; color: #555; display: block; margin-bottom: 5px; }
    input, textarea, select { padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background: #fafafa; }
    .btn { background: #0369a1; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { background: #025686; transform: translateY(-1px); }
    .btn.secondary { background: #6b7280; }
    .btn.ppt { background: #D24726; } 
    .btn.excel { background: #217346; }
    .btn.success { background: #28a745; }
    .btn.danger { background: #dc3545; }
    
    /* TABLE */
    table.data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; font-size: 13px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .data-table th, .data-table td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; vertical-align: middle; }
    .data-table th { background: #0369a1; color: white; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
    .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }

    /* MODAL (FOR PREVIEW) */
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index: 1000; }
    .modal-content { background:white; width: 900px; max-width: 95%; height: 90vh; border-radius:8px; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; background: #525659; display: flex; justify-content: center; }

    /* REPORT STYLE (For Preview & PDF) */
    .report-control-bar { background: #eef2f6; padding: 20px; border-radius: 8px; display: flex; gap: 15px; align-items: end; margin-bottom: 20px; }
    .preview-box { background: white; border: 1px solid #ddd; padding: 40px; min-height: 500px; margin-top: 20px; border-radius: 8px; }
    
    .slide-card { 
        border: 1px solid #ddd; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        margin-bottom: 30px; 
        padding: 0; 
        background: white; 
        display: flex; 
        overflow: hidden; 
        position: relative;
        page-break-inside: avoid !important;
    }
    .slide-sidebar { width: 40px; background: linear-gradient(180deg, #cde4f7 0%, #ffffff 100%); flex-shrink: 0; border-right: 1px solid #eee; }
    .slide-content { padding: 30px; flex: 1; position: relative; }
    .slide-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .slide-title { font-size: 28px; color: #003366; font-weight: bold; margin: 0; }
    .slide-logo { height: 40px; object-fit: contain; }
    .slide-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 30px; }
    
    .info-block { margin-bottom: 15px; }
    .defect-rate-huge { color: #D93025; font-size: 22px; font-weight: bold; margin-left: 10px; }
    
    .mini-table { width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 20px; text-align: center; }
    .mini-table th { background: #ED7D31; color: white; padding: 8px; border: 1px solid #fff; }
    .mini-table td { background: #FCE4D6; padding: 8px; border: 1px solid white; color: #333; }

    .img-section { text-align: center; }
    .img-label { background: #5B9BD5; color: white; display: inline-block; padding: 5px 15px; font-weight: bold; margin-bottom: 10px; border-radius: 4px; font-size: 12px; white-space: normal; max-width: 90%; }
    .img-stack { display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .slide-img { width: 100%; max-height: 200px; object-fit: contain; border: 4px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); background: #333; }
    
    .target-icon { width: 40px; height: 40px; background: radial-gradient(circle, #e74c3c 15%, transparent 15%, transparent 30%, #e74c3c 30%, #e74c3c 45%, transparent 45%, transparent 100%); border: 2px solid #e74c3c; border-radius: 50%; display: inline-block; vertical-align: middle; }

  </style>
</head>

<body>

<div class="card">
  <div class="header-row">
      <h2>Incoming Rejection Tracker</h2>
      <img id="mainLogo" src="https://i.postimg.cc/5y7SN4xc/logo.png" class="app-logo" crossorigin="anonymous" alt="Logo">
  </div>

  <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('entry')">Daily Entry</button>
      <button class="tab-btn" onclick="switchTab('report')">Monthly Report</button>
  </div>

  <!-- ENTRY TAB -->
  <div id="entryTab" class="tab-content active">
      <input type="hidden" id="editRowIndex">
      <div class="form-grid">
          <div><label>Date</label><input id="date" type="date"></div>
          <div><label>ODM Name</label><input id="odm" placeholder="e.g. Glanto"></div>
          <div><label>Model</label><input id="model" placeholder="e.g. AD 141/148"></div>
          <div><label>PO Number</label><input id="po"></div>
      </div>
      <div class="form-grid">
          <div><label>Item Name</label><input id="item" placeholder="e.g. Light Guide"></div>
          <div><label>Defect Rate %</label><input id="defectRate" type="number" step="0.01" placeholder="%"></div>
          <div><label>Prepared By</label><input id="preparedBy"></div>
          <div><label>Upload Images (Max 3)</label><input id="images" type="file" accept="image/*" multiple></div>
      </div>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div><label>Defect Details</label><textarea id="defectDetails" rows="3"></textarea></div>
          <div><label>RCA / Remarks</label><textarea id="rca" rows="3"></textarea></div>
      </div>
      <div style="margin-top:20px;">
          <button id="saveBtn" class="btn">Save Record</button>
          <button id="clearBtn" class="btn secondary">Clear Form</button>
          <button id="refreshBtn" class="btn secondary" style="float:right">Refresh List</button>
      </div>

      <table id="dataTable" class="data-table">
        <thead><tr><th>Date</th><th>ODM</th><th>Model</th><th>Defect</th><th>Rate%</th><th>Image</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
  </div>

  <!-- REPORT TAB -->
  <div id="reportTab" class="tab-content">
      <div class="report-control-bar">
          <div style="flex:1">
              <label>Select Month & Year</label>
              <input type="month" id="reportMonthInput">
          </div>
          <button class="btn" onclick="generateReport()">üîç Preview Report</button>
      </div>

      <div id="reportActions" style="display:none; justify-content: flex-end; gap:10px; margin-bottom:10px;">
          <button id="btnPPT" class="btn ppt">üìä Download PPT</button>
          <button id="btnExcel" class="btn excel">‚¨á Excel</button>
          <button id="btnPDF" class="btn success">‚¨á Download PDF</button>
      </div>

      <div id="monthlyReportPreview" class="preview-box">
          <div style="text-align:center; color:#999; margin-top:50px;">Select Month to Preview</div>
      </div>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">Quick Preview</h3>
            <button onclick="closeModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modalContent" style="width:100%; background:white; padding:20px;"></div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGCDn3USDWCByX5a-rgiZDkX-YwdfH4y1bd6_PgpLs-ZXgLo9FG5eboPSt4zKI8TfEcA/exec"; 
const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png";

let allData = [];
let currentReportData = [];
let base64Logo = "";

// Pre-load Logo safely
function convertLogoToBase64() {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.onload = function(){
        const canvas = document.createElement('canvas');
        canvas.width = img.width; canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        base64Logo = canvas.toDataURL('image/png');
    };
    img.onerror = function() { console.warn("Logo blocked."); };
    img.src = LOGO_URL;
}

function readFilesAndCompress(files) {
  return Promise.all([...files].map(file => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        let w = img.width, h = img.height;
        if(w > 800) { h *= 800/w; w = 800; }
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', 0.7));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  })));
}

// --- CORE ACTIONS ---

async function saveRecord(){
    const btn = document.getElementById('saveBtn');
    btn.innerText="Saving..."; btn.disabled=true;
    let imgs = [];
    const files = document.getElementById('images').files;
    if(files.length) imgs = await readFilesAndCompress(files);

    const rid = document.getElementById('editRowIndex').value;
    if(rid && !imgs.length){
        let old = allData.find(x=>x._rowIndex==rid);
        if(old && old.ImageURLs) imgs = old.ImageURLs.split(" || ");
    }

    const rec = {
        date: document.getElementById('date').value,
        odm: document.getElementById('odm').value,
        model: document.getElementById('model').value,
        po: document.getElementById('po').value,
        item: document.getElementById('item').value,
        defectDetails: document.getElementById('defectDetails').value,
        defectRate: document.getElementById('defectRate').value,
        rca: document.getElementById('rca').value,
        preparedBy: document.getElementById('preparedBy').value,
        images: imgs
    };

    try{
        let res = await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify({ action:rid?"update":"create", record:rec, rowIndex:rid }) });
        let j = await res.json();
        if(j.status==="success"){ alert("Saved!"); clearForm(); loadData(); }
        else alert("Error: "+j.message);
    }catch(e){console.error(e); alert("Connection Error");}
    btn.innerText="Save Record"; btn.disabled=false;
}

async function deleteRec(id) {
    if(!confirm("Are you sure you want to DELETE this record?")) return;
    try {
        let res = await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify({ action:"delete", rowIndex:id }) });
        let j = await res.json();
        if(j.status==="success"){ alert("Deleted!"); loadData(); }
        else alert("Error: "+j.message);
    } catch(e) { alert("Delete failed"); }
}

function editRec(id){
    let r = allData.find(x=>x._rowIndex==id);
    if(!r) return;
    document.getElementById('date').value = r.Date.replace("'","");
    document.getElementById('odm').value = r.ODM;
    document.getElementById('model').value = r.Model;
    document.getElementById('po').value = r.PO;
    document.getElementById('item').value = r.Item;
    document.getElementById('defectDetails').value = r.DefectDetails;
    document.getElementById('defectRate').value = r.DefectRate;
    document.getElementById('rca').value = r.RCA;
    document.getElementById('preparedBy').value = r.PreparedBy;
    document.getElementById('editRowIndex').value = id;
    document.getElementById('saveBtn').innerText="Update Record";
    switchTab('entry');
    window.scrollTo(0,0);
}

function clearForm(){
    document.querySelectorAll('#entryTab input, #entryTab textarea').forEach(e=>e.value="");
    document.getElementById('editRowIndex').value="";
    document.getElementById('saveBtn').innerText="Save Record";
}

async function loadData(){
    const tb = document.querySelector("#dataTable tbody");
    if(!tb) return;
    tb.innerHTML="<tr><td colspan='7' align='center'>Loading...</td></tr>";
    try{
        let res = await fetch(SCRIPT_URL);
        let j = await res.json();
        allData = j.rows;
        renderTable(allData);
    }catch(e){ 
        console.error(e); 
        tb.innerHTML="<tr><td colspan='7'>Error loading data</td></tr>"; 
    }
}

function renderTable(rows){
    const tb = document.querySelector("#dataTable tbody");
    if(!tb) return;
    tb.innerHTML="";
    if(!rows || rows.length === 0) { tb.innerHTML="<tr><td colspan='7'>No Data</td></tr>"; return; }
    
    rows.forEach(r=>{
        let img = (r.ImageURLs||"").split(" || ")[0];
        let thumb = img ? `<img src="${img}" class="thumb">` : "";
        let tr = document.createElement("tr");
        
        // Added 3 Action Buttons: Preview, Edit, Delete
        tr.innerHTML=`
            <td>${r.Date.replace("'","")}</td>
            <td>${r.ODM}</td>
            <td>${r.Model}</td>
            <td>${r.DefectDetails.substring(0,30)}...</td>
            <td style="color:${r.DefectRate>5?'red':'green'}">${r.DefectRate}%</td>
            <td>${thumb}</td>
            <td style="white-space:nowrap;">
                <button class="btn secondary" style="padding:4px 8px;" onclick="previewSingle(${r._rowIndex})">üëÅÔ∏è</button>
                <button class="btn secondary" style="padding:4px 8px;" onclick="editRec(${r._rowIndex})">‚úèÔ∏è</button>
                <button class="btn danger" style="padding:4px 8px;" onclick="deleteRec(${r._rowIndex})">üóëÔ∏è</button>
            </td>`;
        tb.appendChild(tr);
    });
}

function previewSingle(id) {
    let r = allData.find(x => x._rowIndex == id);
    if(!r) return;
    
    // Quick generate HTML for modal
    let trend = getTrendDataForModel(r.Model);
    let html = generateSlideHTML(r, trend);
    
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('previewModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('previewModal').style.display = 'none';
}

// --- HELPER FOR SLIDE GENERATION (Shared by Preview & Report) ---
function generateSlideHTML(row, trend) {
    let trendKeys = Object.keys(trend).slice(-6);
    let th="", tr1="", tr2="", tr3="";
    trendKeys.forEach(k => {
        th += `<th>${k}</th>`;
        tr1 += `<td>${trend[k].qty}</td>`;
        tr2 += `<td>${trend[k].def}</td>`;
        tr3 += `<td>${trend[k].rate}%</td>`;
    });

    let imgs = (row.ImageURLs||"").split(" || ").filter(Boolean);
    let imgHTML = imgs.length ? imgs.slice(0,2).map(url => `<img src="${url}" crossorigin="anonymous" class="slide-img">`).join("") : `<div style="padding:20px; color:#999">No Images</div>`;

    return `
    <div class="slide-card">
        <div class="slide-sidebar"></div>
        <div class="slide-content">
            <div class="slide-header">
                <h1 class="slide-title">${row.ODM}</h1>
                <img src="${base64Logo || LOGO_URL}" class="slide-logo">
            </div>
            <div class="slide-grid">
                <div>
                    <div class="info-block" style="font-size:16px;">
                        ‚ùñ <b>Model :- ${row.Model}</b><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;Item :- ${row.Item}
                    </div>
                    <div class="info-block" style="background:#f9f9f9; padding:10px; border-left:4px solid #0369a1;">
                        <b style="color:#0369a1">Issues</b><br>${row.DefectDetails}
                    </div>
                    <div class="info-block" style="display:flex; align-items:center;">
                        <div class="target-icon"></div>
                        <span class="defect-rate-huge">Rejection Rate % &nbsp; ~${row.DefectRate}%</span>
                    </div>
                    <table class="mini-table">
                        <tr><th>Index</th> ${th} </tr>
                        <tr><td>Prod</td> ${tr1} </tr>
                        <tr><td>Defect</td> ${tr2} </tr>
                        <tr><td>Defect %</td> ${tr3} </tr>
                    </table>
                </div>
                <div class="img-section">
                    <div class="img-label">${row.DefectDetails}</div>
                    <div class="img-stack">${imgHTML}</div>
                </div>
            </div>
        </div>
    </div>`;
}

// --- REPORT LOGIC ---

function getTrendDataForModel(modelName) {
    let trend = {};
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    allData.forEach(r => {
        if(r.Model === modelName && r.Date) {
            let d = new Date(r.Date.replace("'",""));
            if(!isNaN(d)) {
                let mKey = months[d.getMonth()] + "'" + d.getFullYear().toString().substr(2);
                if(!trend[mKey]) trend[mKey] = { rate:0, count:0, qty:0 };
                trend[mKey].rate = parseFloat(r.DefectRate);
                trend[mKey].qty = 1000; 
                trend[mKey].def = Math.round(1000 * (r.DefectRate/100));
            }
        }
    });
    return trend;
}

function generateReport() {
    const mInput = document.getElementById('reportMonthInput').value;
    if(!mInput) return alert("Select Month");
    const [yr, mo] = mInput.split('-');
    currentReportData = allData.filter(r => r.Date.replace("'","").startsWith(`${yr}-${mo}`));
    
    if(!currentReportData.length) {
        document.getElementById('monthlyReportPreview').innerHTML = "<h3 align='center'>No Data Found</h3>";
        document.getElementById('reportActions').style.display='none';
        return;
    }

    let html = `<div id="exportWrapper" style="padding:10px;">`;
    currentReportData.forEach(row => {
        let trend = getTrendDataForModel(row.Model);
        html += generateSlideHTML(row, trend);
    });
    html += `</div>`;
    
    document.getElementById('monthlyReportPreview').innerHTML = html;
    document.getElementById('reportActions').style.display='flex';
}

// --- EXPORT FUNCTIONS ---

function downloadPDFReport(){
    const el = document.getElementById('exportWrapper');
    html2pdf().set({ 
        margin: [5, 5, 5, 5], 
        filename:'Report.pdf', 
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas:{ scale:2, useCORS: true }, 
        jsPDF:{ unit:'mm', format:'a4', orientation:'landscape'},
        pagebreak: { mode: ['css', 'legacy'] } 
    }).from(el).save();
}

function downloadExcel(){
    if(!currentReportData.length) return;
    const ws = XLSX.utils.json_to_sheet(currentReportData.map(r=>({
        Date:r.Date, ODM:r.ODM, Model:r.Model, Item:r.Item, Issue:r.DefectDetails, Rate:r.DefectRate+"%", RCA:r.RCA
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "Report_Data.xlsx");
}

async function downloadProfessionalPPT() {
    if(!currentReportData.length) return;
    const btn = document.getElementById('btnPPT');
    btn.innerText = "Processing...";
    
    try {
        let pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';

        pptx.defineSlideMaster({
            title: "DASHBOARD",
            background: { color: "FFFFFF" },
            objects: [
                { rect: { x: 0, y: 0, w: 0.4, h: "100%", fill: { type: 'solid', color: 'A9D0F5' } } }, 
                { rect: { x: 0.4, y: 0, w: 0.2, h: "100%", fill: { type: 'solid', color: 'E1F0FB' } } },
                (base64Logo ? { image: { data: base64Logo, x: 8.5, y: 0.2, w: 1.2, h: 0.6 } } : null)
            ].filter(Boolean)
        });

        // Loop rows
        for(let row of currentReportData) {
            let slide = pptx.addSlide({ masterName: "DASHBOARD" });

            slide.addText(row.ODM || "ODM", { x: 0.8, y: 0.4, fontSize: 28, color: '003366', bold: true });
            slide.addText(`‚ùñ Model :- ${row.Model||""}`, { x: 0.8, y: 1.2, fontSize: 16, color: '000000', bold: true });
            slide.addText(`      Item :- ${row.Item||""}`, { x: 0.8, y: 1.5, fontSize: 14, color: '333333' });

            slide.addText("Issues", { x: 1.5, y: 1.9, fontSize: 14, color: '000000', bold: true });
            slide.addText(row.DefectDetails || "No details", { x: 1.5, y: 2.2, w: 4.8, h: 0.8, fontSize: 14, color: '333333', wrap: true, valign: 'top' });

            // SIMPLE TARGET ICON (CIRCLE) TO PREVENT CRASH
            slide.addShape(pptx.ShapeType.ellipse, { x:0.8, y:2.5, w:0.8, h:0.8, fill:'40E0D0', line:{width:0} }); 
            slide.addShape(pptx.ShapeType.ellipse, { x:0.95, y:2.65, w:0.5, h:0.5, fill:{type:'none'}, line:{color:'FFFFFF', width:2} });
            
            slide.addText(`Rejection Rate %   ~${row.DefectRate}%`, { x: 1.8, y: 2.7, fontSize: 18, color: 'CC0000', bold: true });

            // Charts & Tables
            let trend = getTrendDataForModel(row.Model);
            let labels = Object.keys(trend).slice(-6); 
            let dataRate = labels.map(k => parseFloat(trend[k].rate) || 0);
            let dataDef = labels.map(k => parseFloat(trend[k].def) || 0);
            let dataProd = labels.map(k => parseFloat(trend[k].qty) || 0);

            slide.addText(`${(row.Item||"").toUpperCase()} DEFECT TREND`, { x: 0.8, y: 3.4, w: 5.0, fontSize: 10, color: '666666', bold: true, align: 'center' });

            if (labels.length > 0) {
                try {
                    let chartData = [
                        { name: "Defect Qty", type: pptx.ChartType.bar, data: dataDef, labels: labels },
                        { name: "Defect %", type: pptx.ChartType.line, data: dataRate, labels: labels }
                    ];
                    slide.addChart(pptx.ChartType.bar, chartData, { x: 0.8, y: 3.6, w: 5.5, h: 2.5, barDir: 'col', chartColors: ['ED7D31', 'A5A5A5'], showValue: true, valAxisHidden: true, gridLine: { style: 'none' } });
                } catch(e){}
            }

            let tableRows = [
                [{ text: "Index", options:{fill:'ED7D31', color:'FFFFFF', bold:true} }, ...labels.map(l => ({ text: l, options:{fill:'ED7D31', color:'FFFFFF', bold:true} }))],
                [{ text: "Prod", options:{fill:'FCE4D6', bold:true} }, ...dataProd.map(v => ({ text: v, options:{fill:'FCE4D6'} }))],
                [{ text: "Defect", options:{fill:'FCE4D6', bold:true} }, ...dataDef.map(v => ({ text: v, options:{fill:'FCE4D6'} }))],
                [{ text: "Defect %", options:{fill:'FCE4D6', bold:true} }, ...dataRate.map(v => ({ text: v+"%", options:{fill:'FCE4D6'} }))]
            ];
            slide.addTable(tableRows, { x: 0.8, y: 6.2, w: 5.5, fontSize: 9, align: 'center', border: { pt: 1, color: 'FFFFFF' } });

            slide.addText("Defect\nImages", { x: 6.5, y: 1.2, w: 1.0, fontSize: 10, bold: true, align: 'right' });
            slide.addShape(pptx.ShapeType.rect, { x: 7.6, y: 1.2, w: 2.2, h: 0.6, fill: '5B9BD5' });
            slide.addText("‚Ä¢ " + (row.DefectDetails || ""), { x: 7.6, y: 1.2, w: 2.2, h: 0.6, fontSize: 11, color: 'FFFFFF', bold: true, align: 'left', valign: 'middle', wrap: true });

            let imgs = (row.ImageURLs||"").split(" || ").filter(Boolean);
            let imgY = 1.9;
            for(let i=0; i<Math.min(imgs.length, 2); i++) {
                try {
                    if(imgs[i] && imgs[i].length > 100) {
                        if(imgs[i].startsWith("data:image")) slide.addImage({ data: imgs[i], x: 7.0, y: imgY, w: 2.8, h: 2.2 });
                        else slide.addImage({ path: imgs[i], x: 7.0, y: imgY, w: 2.8, h: 2.2 });
                        imgY += 2.4;
                    }
                } catch(e) {}
            }
            slide.addShape(pptx.ShapeType.arc, { x: 9.0, y: 6.5, w: 1.5, h: 1.5, line: { color: '333333', width: 2 } });
        }

        pptx.writeFile({ fileName: `Professional_Report.pptx` }).then(() => {
            btn.innerText = "üìä Download PPT";
        });

    } catch(e) {
        alert("PPT Error: " + e.message);
        btn.innerText = "üìä Download PPT";
    }
}

function switchTab(t){
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
    document.getElementById(t+'Tab').classList.add('active');
    // Toggle active logic simplified
    const btns = document.querySelectorAll('.tab-btn');
    if(t==='entry') btns[0].classList.add('active'); else btns[1].classList.add('active');
}

// SETUP ON LOAD
document.addEventListener('DOMContentLoaded', function() {
    convertLogoToBase64();
    loadData();
    document.getElementById('saveBtn').onclick = saveRecord;
    document.getElementById('clearBtn').onclick = clearForm;
    document.getElementById('refreshBtn').onclick = loadData;
    document.getElementById('btnPPT').onclick = downloadProfessionalPPT;
    document.getElementById('btnExcel').onclick = downloadExcel;
    document.getElementById('btnPDF').onclick = downloadPDFReport;
});
</script>
</body>
</html>
