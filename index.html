<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ODM Major Issues</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <!-- html2pdf Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
    
    /* --- HEADER STYLES UPDATED FOR LOGO --- */
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .header-row h2 { color: #0369a1; margin: 0; border: none; padding: 0; }
    .app-logo { height: 50px; object-fit: contain; }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; }
    input, textarea, select { padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    
    .btn { background: #0369a1; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn:hover { background: #025686; }
    .btn.secondary { background: #6b7280; }
    .btn.danger { background: #dc3545; }
    .btn.success { background: #28a745; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
    th { background: #0369a1; color: white; }
    
    .thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }

    /* Modal Styles */
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index: 1000; }
    .modal-content { background:white; width: 800px; max-width: 95%; height: 90vh; border-radius:8px; display: flex; flex-direction: column; }
    .modal-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; background: #f9f9f9; }
    .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; background: #fff; border-radius: 0 0 8px 8px;}

    /* Report Layout */
    .report-container { background: white; padding: 30px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    /* Updated Report Header for Logo */
    .report-header-center { text-align: center; margin-bottom: 15px; }
    .report-logo { height: 60px; margin-bottom: 10px; }
    
    .report-title { text-align: center; color: #0369a1; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
    .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .report-table td { padding: 8px; border: 1px solid #ccc; }
    .report-label { background: #f0f8ff; font-weight: bold; width: 30%; }
    .report-img-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    .report-img { max-width: 200px; max-height: 200px; border: 1px solid #ddd; padding: 5px; }
  </style>
</head>

<body>

<div class="card">
  <!-- LOGO ADDED HERE -->
  <div class="header-row">
      <h2>ODM Major Issues</h2>
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="app-logo" alt="Logo">
  </div>

  <input type="hidden" id="editRowIndex">

  <div class="form-grid">
      <div><label>Date</label><input id="date" type="date"></div>
      <div><label>ODM</label><input id="odm"></div>
      <div><label>Model</label><input id="model"></div>
      <div><label>PO Number</label><input id="po"></div>
  </div>

  <div class="form-grid">
      <div><label>Item Name</label><input id="item"></div>
      <div><label>Defect Rate %</label><input id="defectRate" type="number" placeholder="%"></div>
      <div><label>Prepared By</label><input id="preparedBy"></div>
      <div><label>Upload Images (Max 3)</label><input id="images" type="file" accept="image/*" multiple></div>
  </div>

  <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
      <div><label>Defect Details</label><textarea id="defectDetails" rows="3"></textarea></div>
      <div><label>RCA / Remarks</label><textarea id="rca" rows="3"></textarea></div>
  </div>

  <div style="margin-top:10px;">
      <button id="saveBtn" class="btn">Save Record</button>
      <button id="clearBtn" class="btn secondary">Clear Form</button>
      <button id="refreshBtn" class="btn secondary" style="float:right">Refresh List</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr><th>Date</th><th>Model</th><th>Defect</th><th>Rate%</th><th>RCA</th><th>Image</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- PREVIEW MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">üìÑ Report Preview</h3>
      <button onclick="closeModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div id="printArea" class="report-container">
          <!-- LOGO ADDED TO REPORT HERE -->
          <div class="report-header-center">
              <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="report-logo" alt="Logo" crossorigin="anonymous">
          </div>
          
          <h2 class="report-title">Defect Analysis Report</h2>
          <table class="report-table">
              <tr><td class="report-label">Date</td><td id="rep_date"></td><td class="report-label">Prepared By</td><td id="rep_prep"></td></tr>
              <tr><td class="report-label">ODM</td><td id="rep_odm"></td><td class="report-label">Model</td><td id="rep_model"></td></tr>
              <tr><td class="report-label">PO Number</td><td id="rep_po"></td><td class="report-label">Item</td><td id="rep_item"></td></tr>
          </table>
          <table class="report-table">
              <tr><td class="report-label">Defect Details</td><td id="rep_desc"></td></tr>
              <tr><td class="report-label">Defect Rate</td><td id="rep_rate" style="font-weight:bold; color:red;"></td></tr>
              <tr><td class="report-label">RCA / Remarks</td><td id="rep_rca"></td></tr>
          </table>
          <div style="margin-top:20px; border-top:2px solid #eee; padding-top:10px;">
              <h4 style="margin:0 0 10px 0;">Defect Images:</h4>
              <div id="rep_images" class="report-img-grid"></div>
          </div>
      </div>
    </div>
    <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal()">Close</button>
        <button class="btn success" onclick="downloadPDF()">‚¨á Download PDF</button>
    </div>
  </div>
</div>

<script>
// ‚ö†Ô∏è YAHAN APNA SCRIPT URL PASTE KAREIN
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGCDn3USDWCByX5a-rgiZDkX-YwdfH4y1bd6_PgpLs-ZXgLo9FG5eboPSt4zKI8TfEcA/exec";

let allData = [];

// --- UTILS ---
function escapeHtml(s){ return s ? String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }

function readFilesAndCompress(files) {
  return Promise.all([...files].map(file => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        // Reduce size for faster upload
        let w = img.width, h = img.height;
        if(w > 800) { h *= 800/w; w = 800; }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        resolve({ name: file.name, data: canvas.toDataURL('image/jpeg', 0.6) });
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  })));
}

// --- SAVE FUNCTION ---
async function saveRecord(){
  const btn = document.getElementById('saveBtn');
  btn.innerText = "Uploading..."; btn.disabled = true;

  const fileInput = document.getElementById('images');
  let imgs = [];
  if(fileInput.files.length > 0) {
      imgs = await readFilesAndCompress(fileInput.files);
  }

  const rowIndex = document.getElementById('editRowIndex').value;
  const action = rowIndex ? "update" : "create";

  // Edit mode logic: Keep old images if no new ones are selected
  if(action === "update" && imgs.length === 0){
      let oldRow = allData.find(r => r._rowIndex == rowIndex);
      if(oldRow && oldRow.ImageURLs) {
          imgs = oldRow.ImageURLs.split(" || ").map(url => ({ data: url }));
      }
  }

  let record = {
    date: document.getElementById('date').value,
    odm: document.getElementById('odm').value,
    model: document.getElementById('model').value,
    po: document.getElementById('po').value,
    item: document.getElementById('item').value,
    defectDetails: document.getElementById('defectDetails').value,
    defectRate: document.getElementById('defectRate').value,
    rca: document.getElementById('rca').value,
    remarks: "", 
    preparedBy: document.getElementById('preparedBy').value,
    images: imgs 
  };

  try {
      let res = await fetch(SCRIPT_URL, { method:"POST", body: JSON.stringify({ action, record, rowIndex }) });
      let j = await res.json();
      if(j.status==="success"){
        alert("‚úÖ Saved Successfully!");
        clearForm();
        loadData();
      } else { alert("Failed: "+j.message); }
  } catch(e){ console.error(e); alert("Error saving."); }
  
  btn.innerText = "Save Record"; btn.disabled = false;
}

function clearForm(){
  document.querySelectorAll('input, textarea').forEach(el => el.value = "");
  document.getElementById('saveBtn').innerText = "Save Record";
  document.getElementById('editRowIndex').value = "";
}

// --- LOAD DATA ---
async function loadData(){
  document.querySelector("#dataTable tbody").innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";
  try {
      let res = await fetch(SCRIPT_URL);
      let j = await res.json();
      allData = j.rows;
      renderTable(j.rows);
  } catch(e) { console.error(e); }
}

function renderTable(rows){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  rows.forEach((r, idx) => {
    let imgList = (r.ImageURLs || "").split(" || ").filter(Boolean);
    let thumb = imgList.length ? `<img src="${imgList[0]}" class="thumb" onclick='openPreview(${JSON.stringify(r)})'>` : '<span style="color:#ccc">No Img</span>';

    // Date clean up (remove apostrophe if exists)
    let cleanDate = r.Date ? r.Date.replace("'", "") : "";

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${cleanDate}</td>
      <td>${escapeHtml(r.Model)}</td>
      <td>${escapeHtml(r.DefectDetails)}</td>
      <td>${escapeHtml(r.DefectRate)}</td>
      <td>${escapeHtml(r.RCA)}</td>
      <td>${thumb}</td>
      <td>
        <button class="btn success" style="padding:5px;" onclick='openPreview(${JSON.stringify(r)})'>PDF</button>
        <button class="btn secondary" style="padding:5px;" onclick="editRecord(${r._rowIndex})">Edit</button>
        <button class="btn danger" style="padding:5px;" onclick="deleteRecord(${r._rowIndex})">Del</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editRecord(rowIndex){
  let r = allData.find(x => x._rowIndex == rowIndex);
  if(!r) return;
  document.getElementById('date').value = r.Date.replace("'", "");
  document.getElementById('odm').value = r.ODM;
  document.getElementById('model').value = r.Model;
  document.getElementById('po').value = r.PO;
  document.getElementById('item').value = r.Item;
  document.getElementById('defectDetails').value = r.DefectDetails;
  document.getElementById('defectRate').value = r.DefectRate;
  document.getElementById('rca').value = r.RCA;
  document.getElementById('preparedBy').value = r.PreparedBy;
  document.getElementById('editRowIndex').value = rowIndex;
  document.getElementById('saveBtn').innerText = "Update Record";
  window.scrollTo(0,0);
}

async function deleteRecord(rowIndex){
  if(!confirm("Delete?")) return;
  await fetch(SCRIPT_URL,{ method:"POST", body: JSON.stringify({action:"delete", rowIndex}) });
  loadData();
}

// --- PREVIEW FUNCTION (Fixed) ---
function openPreview(r){
    document.getElementById('rep_date').innerText = (r.Date || "").replace("'", "") || "-";
    document.getElementById('rep_prep').innerText = r.PreparedBy || "-";
    document.getElementById('rep_odm').innerText = r.ODM || "-";
    document.getElementById('rep_model').innerText = r.Model || "-";
    document.getElementById('rep_po').innerText = r.PO || "-";
    document.getElementById('rep_item').innerText = r.Item || "-";
    document.getElementById('rep_desc').innerText = r.DefectDetails || "-";
    document.getElementById('rep_rate').innerText = r.DefectRate + "%" || "-";
    document.getElementById('rep_rca').innerText = r.RCA || "-";

    const imgContainer = document.getElementById('rep_images');
    imgContainer.innerHTML = "";
    
    // Process Images
    let imgs = (r.ImageURLs || "").split(" || ").filter(Boolean);
    
    if(imgs.length > 0){
        imgs.forEach(url => {
            let img = document.createElement('img');
            // ‚úÖ IMPORTANT: This helps html2canvas access the image
            img.crossOrigin = "Anonymous"; 
            img.src = url;
            img.className = 'report-img';
            img.onload = function() { console.log("Image Loaded"); };
            img.onerror = function() { console.log("Image Error"); this.style.display='none'; };
            imgContainer.appendChild(img);
        });
    } else { 
        imgContainer.innerHTML = "<p>No Images</p>"; 
    }
    
    document.getElementById('modal').style.display = 'flex';
}

function closeModal(){ document.getElementById('modal').style.display = 'none'; }

function downloadPDF(){
    const element = document.getElementById('printArea');
    const modelName = document.getElementById('rep_model').innerText;
    
    const opt = {
        margin: 0.5,
        filename: `Defect_Report_${modelName}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true }, // ‚úÖ useCORS is Must
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}

document.getElementById('saveBtn').onclick = saveRecord;
document.getElementById('clearBtn').onclick = clearForm;
document.getElementById('refreshBtn').onclick = loadData;
loadData();
</script>
</body>
</html>
