<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Incoming Rejection Tracker & Professional Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <!-- LIBRARIES -->
  <!-- 1. PDF Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- 2. Excel Generator (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- 3. PowerPoint Generator (PptxGenJS) -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
    
    /* --- TABS STYLE --- */
    .tab-nav { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab-btn { background: none; border: none; padding: 10px 20px; font-size: 16px; font-weight: bold; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-btn.active { color: #0369a1; border-bottom-color: #0369a1; }
    .tab-btn:hover { color: #0369a1; background: #f9fbfd; }
    
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- APP HEADER --- */
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .header-row h2 { color: #0369a1; margin: 0; }
    .app-logo { height: 50px; object-fit: contain; }

    /* --- FORM STYLES --- */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { font-weight: bold; font-size: 12px; color: #555; display: block; margin-bottom: 5px; }
    input, textarea, select { padding: 9px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background: #fafafa; }
    input:focus, textarea:focus { border-color: #0369a1; background: #fff; outline: none; }
    
    .btn { background: #0369a1; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn:hover { background: #025686; transform: translateY(-1px); }
    .btn.secondary { background: #6b7280; }
    .btn.danger { background: #dc3545; }
    .btn.success { background: #28a745; }
    .btn.ppt { background: #D24726; } /* PowerPoint Color */
    .btn.excel { background: #217346; } /* Excel Color */
    
    /* --- DATA TABLE --- */
    table.data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; font-size: 13px; border-radius: 8px; overflow: hidden; }
    .data-table th, .data-table td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; vertical-align: middle; }
    .data-table th { background: #0369a1; color: white; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
    .data-table tr:hover { background: #f9fbfd; }
    
    .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; transition: transform 0.2s; }
    .thumb:hover { transform: scale(1.5); }

    /* --- REPORT SPECIFIC STYLES --- */
    .report-control-bar { background: #eef2f6; padding: 15px; border-radius: 6px; display: flex; gap: 10px; align-items: end; margin-bottom: 20px; }
    .preview-box { background: white; border: 1px solid #ddd; padding: 30px; min-height: 400px; margin-top: 20px; }
    
    .odm-group-header { background: #0369a1; color: white; padding: 10px; margin-top: 20px; border-radius: 4px 4px 0 0; font-weight: bold; display: flex; justify-content: space-between; }
    
    /* --- MODAL (Existing) --- */
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal-content { background:white; width: 850px; max-width: 95%; height: 90vh; border-radius:8px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 8px 8px 0 0; }
    .modal-body { padding: 30px; overflow-y: auto; flex: 1; background: #525659; display: flex; justify-content: center; }
    .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; background: #fff; border-radius: 0 0 8px 8px;}

    /* Report Print Styles (Hidden from UI, used for HTML2PDF) */
    .report-container { background: white; width: 100%; max-width: 210mm; min-height: 297mm; padding: 40px; box-sizing: border-box; }
    .rep-head-wrap { border-bottom: 4px solid #0369a1; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
    .rep-logo { height: 70px; object-fit: contain; }
    .rep-title-box { text-align: right; }
    .rep-title-box h1 { margin: 0; color: #0369a1; font-size: 24px; text-transform: uppercase; }
    
    .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
    .info-card { background: #f8fbff; border: 1px solid #e1e8f0; padding: 15px; border-radius: 6px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px dashed #e0e0e0; padding-bottom: 4px; }
    .rate-box { background: #0369a1; color: white; text-align: center; padding: 15px; border-radius: 6px; }
    .rate-val { font-size: 28px; font-weight: bold; }
    .detail-section { margin-bottom: 30px; }
    .sec-head { background: #eef2f6; color: #0369a1; padding: 8px 12px; font-weight: bold; border-left: 4px solid #0369a1; margin-bottom: 10px; }
    .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
    .report-img { width: 100%; height: 150px; object-fit: contain; border: 1px solid #eee; }
  </style>
</head>

<body>

<div class="card">
  <!-- HEADER & LOGO -->
  <div class="header-row">
      <h2>Incoming Rejection Tracker</h2>
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="app-logo" alt="Logo">
  </div>

  <!-- TABS NAVIGATION -->
  <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('entry')">Daily Entry</button>
      <button class="tab-btn" onclick="switchTab('report')">Monthly Report (ODM Wise)</button>
  </div>

  <!-- TAB 1: ENTRY & LIST -->
  <div id="entryTab" class="tab-content active">
      <input type="hidden" id="editRowIndex">

      <div class="form-grid">
          <div><label>Date</label><input id="date" type="date"></div>
          <div><label>ODM Name</label><input id="odm" placeholder="e.g. Foxconn"></div>
          <div><label>Model</label><input id="model" placeholder="e.g. iPhone 15"></div>
          <div><label>PO Number</label><input id="po"></div>
      </div>

      <div class="form-grid">
          <div><label>Item Name</label><input id="item"></div>
          <div><label>Defect Rate %</label><input id="defectRate" type="number" placeholder="%"></div>
          <div><label>Prepared By</label><input id="preparedBy"></div>
          <div><label>Upload Images (Max 3)</label><input id="images" type="file" accept="image/*" multiple></div>
      </div>

      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div><label>Defect Details</label><textarea id="defectDetails" rows="3"></textarea></div>
          <div><label>RCA / Remarks</label><textarea id="rca" rows="3"></textarea></div>
      </div>

      <div style="margin-top:20px;">
          <button id="saveBtn" class="btn">Save Record</button>
          <button id="clearBtn" class="btn secondary">Clear Form</button>
          <button id="refreshBtn" class="btn secondary" style="float:right">Refresh List</button>
      </div>

      <table id="dataTable" class="data-table">
        <thead>
          <tr><th>Date</th><th>ODM</th><th>Model</th><th>Defect</th><th>Rate%</th><th>Image</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
  </div>

  <!-- TAB 2: MONTHLY REPORT -->
  <div id="reportTab" class="tab-content">
      <div class="report-control-bar">
          <div style="flex:1">
              <label>Select Month & Year</label>
              <input type="month" id="reportMonthInput">
          </div>
          <button class="btn" onclick="generateReport()">üîç Preview Report</button>
      </div>

      <!-- Action Buttons -->
      <div id="reportActions" style="display:none; justify-content: flex-end; gap:10px; margin-bottom:10px;">
          <button class="btn ppt" onclick="downloadDashboardPPT()">üìä Download Professional PPT</button>
          <button class="btn excel" onclick="downloadExcel()">‚¨á Excel</button>
          <button class="btn success" onclick="downloadPDFReport()">‚¨á PDF</button>
      </div>

      <!-- Preview Area -->
      <div id="monthlyReportPreview" class="preview-box">
          <div style="text-align:center; color:#999; margin-top:50px;">
              Select a month and click "Preview Report".
          </div>
      </div>
  </div>

</div>

<!-- INDIVIDUAL RECORD MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0; color:#333;">üìÑ Record Preview</h3>
      <button onclick="closeModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div id="printArea" class="report-container">
          <div class="rep-head-wrap">
              <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="rep-logo" alt="Logo" crossorigin="anonymous">
              <div class="rep-title-box">
                  <h1>Defect Analysis Report</h1>
                  <p>Quality Assurance Dept.</p>
                  <p id="rep_gen_date"></p>
              </div>
          </div>
          <div class="info-section">
              <div class="info-card">
                  <div class="info-row"><span class="info-label">ODM Name</span> <span id="rep_odm" class="info-val"></span></div>
                  <div class="info-row"><span class="info-label">Model No.</span> <span id="rep_model" class="info-val"></span></div>
                  <div class="info-row"><span class="info-label">Item Name</span> <span id="rep_item" class="info-val"></span></div>
                  <div class="info-row"><span class="info-label">PO Number</span> <span id="rep_po" class="info-val"></span></div>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 100px; gap:10px;">
                  <div class="info-card">
                      <div class="info-row"><span class="info-label">Report Date</span> <span id="rep_date" class="info-val"></span></div>
                      <div class="info-row"><span class="info-label">Prepared By</span> <span id="rep_prep" class="info-val"></span></div>
                  </div>
                  <div class="rate-box">
                      <div style="font-size:11px; opacity:0.8">RATE</div>
                      <div id="rep_rate" class="rate-val"></div>
                  </div>
              </div>
          </div>
          <div class="detail-section">
              <div class="sec-head">1. Defect Description</div>
              <div id="rep_desc" style="padding:0 10px;"></div>
          </div>
          <div class="detail-section">
              <div class="sec-head">2. RCA / Remarks</div>
              <div id="rep_rca" style="padding:0 10px;"></div>
          </div>
          <div class="detail-section">
              <div class="sec-head">3. Visual Evidence</div>
              <div id="rep_images" class="img-grid"></div>
          </div>
      </div>
    </div>
    <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal()">Close</button>
        <button class="btn success" onclick="downloadSinglePDF()">Download PDF</button>
    </div>
  </div>
</div>

<script>
// ‚ö†Ô∏è REPLACE WITH YOUR APPS SCRIPT URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGCDn3USDWCByX5a-rgiZDkX-YwdfH4y1bd6_PgpLs-ZXgLo9FG5eboPSt4zKI8TfEcA/exec";

let allData = [];
let currentReportData = []; 

// --- TAB LOGIC ---
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Update button states
    const btns = document.querySelectorAll('.tab-btn');
    if(tabName === 'entry') btns[0].classList.add('active');
    else btns[1].classList.add('active');
}

// --- UTILS ---
function escapeHtml(s){ return s ? String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }

function readFilesAndCompress(files) {
  return Promise.all([...files].map(file => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        if(w > 800) { h *= 800/w; w = 800; }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        resolve({ name: file.name, data: canvas.toDataURL('image/jpeg', 0.6) });
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  })));
}

// --- CRUD OPERATIONS ---
async function saveRecord(){
  const btn = document.getElementById('saveBtn');
  btn.innerText = "Uploading..."; btn.disabled = true;

  const fileInput = document.getElementById('images');
  let imgs = [];
  if(fileInput.files.length > 0) imgs = await readFilesAndCompress(fileInput.files);

  const rowIndex = document.getElementById('editRowIndex').value;
  const action = rowIndex ? "update" : "create";

  if(action === "update" && imgs.length === 0){
      let oldRow = allData.find(r => r._rowIndex == rowIndex);
      if(oldRow && oldRow.ImageURLs) imgs = oldRow.ImageURLs.split(" || ").map(url => ({ data: url }));
  }

  let record = {
    date: document.getElementById('date').value,
    odm: document.getElementById('odm').value,
    model: document.getElementById('model').value,
    po: document.getElementById('po').value,
    item: document.getElementById('item').value,
    defectDetails: document.getElementById('defectDetails').value,
    defectRate: document.getElementById('defectRate').value,
    rca: document.getElementById('rca').value,
    remarks: "", 
    preparedBy: document.getElementById('preparedBy').value,
    images: imgs 
  };

  try {
      let res = await fetch(SCRIPT_URL, { method:"POST", body: JSON.stringify({ action, record, rowIndex }) });
      let j = await res.json();
      if(j.status==="success"){ alert("‚úÖ Saved!"); clearForm(); loadData(); }
      else { alert("Failed: "+j.message); }
  } catch(e){ console.error(e); alert("Error saving."); }
  btn.innerText = "Save Record"; btn.disabled = false;
}

function clearForm(){
  document.querySelectorAll('#entryTab input, #entryTab textarea').forEach(el => el.value = "");
  document.getElementById('saveBtn').innerText = "Save Record";
  document.getElementById('editRowIndex').value = "";
}

async function loadData(){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>Loading Data...</td></tr>";
  try {
      let res = await fetch(SCRIPT_URL);
      let j = await res.json();
      allData = j.rows;
      renderTable(j.rows);
  } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='7'>Error Loading</td></tr>"; }
}

function renderTable(rows){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  if(rows.length === 0) { tbody.innerHTML = "<tr><td colspan='7'>No Records</td></tr>"; return; }
  
  rows.forEach((r) => {
    let imgList = (r.ImageURLs || "").split(" || ").filter(Boolean);
    let thumb = imgList.length ? `<img src="${imgList[0]}" class="thumb" onclick='openSinglePreview(${JSON.stringify(r)})'>` : '<span style="color:#ccc">No Img</span>';
    let cleanDate = r.Date ? r.Date.replace("'", "") : "";

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${cleanDate}</td>
      <td>${escapeHtml(r.ODM)}</td>
      <td>${escapeHtml(r.Model)}</td>
      <td>${escapeHtml(r.DefectDetails).substring(0,30)}...</td>
      <td style="color:${r.DefectRate>5?'red':'green'}">${escapeHtml(r.DefectRate)}%</td>
      <td>${thumb}</td>
      <td>
        <button class="btn secondary" style="padding:2px 5px;" onclick="editRecord(${r._rowIndex})">‚úé</button>
        <button class="btn danger" style="padding:2px 5px;" onclick="deleteRecord(${r._rowIndex})">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editRecord(rowIndex){
  let r = allData.find(x => x._rowIndex == rowIndex);
  if(!r) return;
  document.getElementById('date').value = r.Date.replace("'", "");
  document.getElementById('odm').value = r.ODM;
  document.getElementById('model').value = r.Model;
  document.getElementById('po').value = r.PO;
  document.getElementById('item').value = r.Item;
  document.getElementById('defectDetails').value = r.DefectDetails;
  document.getElementById('defectRate').value = r.DefectRate;
  document.getElementById('rca').value = r.RCA;
  document.getElementById('preparedBy').value = r.PreparedBy;
  document.getElementById('editRowIndex').value = rowIndex;
  document.getElementById('saveBtn').innerText = "Update Record";
  switchTab('entry');
  window.scrollTo(0,0);
}

async function deleteRecord(rowIndex){
  if(!confirm("Delete this record?")) return;
  await fetch(SCRIPT_URL,{ method:"POST", body: JSON.stringify({action:"delete", rowIndex}) });
  loadData();
}

// --- SINGLE PREVIEW MODAL ---
function openSinglePreview(r){
    document.getElementById('rep_date').innerText = (r.Date||"").replace("'","");
    document.getElementById('rep_gen_date').innerText = new Date().toLocaleDateString();
    document.getElementById('rep_prep').innerText = r.PreparedBy;
    document.getElementById('rep_odm').innerText = r.ODM;
    document.getElementById('rep_model').innerText = r.Model;
    document.getElementById('rep_po').innerText = r.PO;
    document.getElementById('rep_item').innerText = r.Item;
    document.getElementById('rep_desc').innerText = r.DefectDetails;
    document.getElementById('rep_rate').innerText = r.DefectRate + "%";
    document.getElementById('rep_rca').innerText = r.RCA;

    const box = document.getElementById('rep_images'); box.innerHTML="";
    let imgs = (r.ImageURLs||"").split(" || ").filter(Boolean);
    imgs.forEach(url=>{
        let img = document.createElement('img'); img.src=url; img.className="report-img";
        box.appendChild(img);
    });
    document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function downloadSinglePDF(){
    const el = document.getElementById('printArea');
    html2pdf().set({ margin:5, filename: 'Single_Defect_Report.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} }).from(el).save();
}

// =========================================================
// --- REPORT & EXPORT LOGIC ---
// =========================================================

function generateReport() {
    const monthInput = document.getElementById('reportMonthInput').value;
    if (!monthInput) { alert("Please select a month first."); return; }
    
    const [year, month] = monthInput.split('-');
    const filtered = allData.filter(row => {
        let d = row.Date.replace("'", ""); 
        return d.startsWith(`${year}-${month}`);
    });

    if(filtered.length === 0) {
        document.getElementById('monthlyReportPreview').innerHTML = "<h3 style='text-align:center'>No Data Found</h3>";
        document.getElementById('reportActions').style.display = 'none';
        return;
    }

    currentReportData = filtered;

    // Group by ODM
    const groups = {};
    filtered.forEach(item => {
        if(!groups[item.ODM]) groups[item.ODM] = [];
        groups[item.ODM].push(item);
    });

    // Preview HTML (Simplified for Screen)
    let html = `<div id="exportableReport" style="padding:20px;">
        <h2 style="color:#0369a1; border-bottom:2px solid #0369a1">Monthly Report: ${monthInput}</h2>`;
    
    for (const [odm, items] of Object.entries(groups)) {
        html += `<div class="odm-group-header">${odm}</div>
        <table class="data-table">
            <thead><tr><th>Date</th><th>Model</th><th>Defect Rate</th><th>Details</th></tr></thead>
            <tbody>`;
        items.forEach(r => {
            html += `<tr>
                <td>${r.Date.replace("'","")}</td>
                <td>${r.Model}</td>
                <td style="font-weight:bold">${r.DefectRate}%</td>
                <td>${r.DefectDetails}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
    }
    html += `</div>`;

    document.getElementById('monthlyReportPreview').innerHTML = html;
    document.getElementById('reportActions').style.display = 'flex';
}

function downloadPDFReport() {
    const el = document.getElementById('exportableReport');
    const month = document.getElementById('reportMonthInput').value;
    html2pdf().set({ margin: 10, filename: `Report_${month}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }).from(el).save();
}

function downloadExcel() {
    if(!currentReportData.length) return;
    const excelData = currentReportData.map(row => ({
        Date: row.Date.replace("'",""), ODM: row.ODM, Model: row.Model, PO: row.PO,
        Item: row.Item, Details: row.DefectDetails, Rate: row.DefectRate+"%", RCA: row.RCA, PrepBy: row.PreparedBy
    }));
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Report");
    XLSX.writeFile(wb, `Report.xlsx`);
}

// =========================================================
// --- ‚ö° PROFESSIONAL DASHBOARD PPT GENERATOR ‚ö° ---
// =========================================================

function downloadDashboardPPT() {
    if(!currentReportData.length) return;
    
    const month = document.getElementById('reportMonthInput').value;
    let pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16x9';

    // -- 1. DEFINE MASTER SLIDE (Footer, Logo) --
    pptx.defineSlideMaster({
        title: "MASTER_SLIDE",
        background: { color: "FFFFFF" },
        objects: [
            { line: { x: 0, y: 6.9, w: '100%', h: 0, line: { color: '0369a1', width: 2 } } }, // Footer Line
            { text: { text: "Quality Assurance Department - Internal Confidential", options: { x: 0.5, y: 7.0, w: '50%', fontSize: 9, color: '666666' } } },
            { text: { text: `Generated: ${new Date().toLocaleDateString()}`, options: { x: 8.5, y: 7.0, w: '15%', fontSize: 9, color: '666666', align: 'right' } } },
        ]
    });

    // -- 2. TITLE SLIDE --
    let slide = pptx.addSlide({ masterName: "MASTER_SLIDE" });
    slide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: 7.5, fill: { color: 'F0F2F5' } }); // Light Bg
    slide.addShape(pptx.ShapeType.rect, { x: 0, y: 2.5, w: '100%', h: 2.0, fill: { color: '0369a1' } }); // Blue Band
    
    slide.addText("MONTHLY QUALITY DASHBOARD", { x: 0, y: 2.8, w: '100%', fontSize: 36, color: 'FFFFFF', bold: true, align: 'center' });
    slide.addText(`Review Period: ${month}`, { x: 0, y: 3.8, w: '100%', fontSize: 18, color: 'E1E8F0', align: 'center' });

    // Group Data
    const groups = {};
    currentReportData.forEach(item => {
        if(!groups[item.ODM]) groups[item.ODM] = [];
        groups[item.ODM].push(item);
    });

    // -- 3. GENERATE SLIDES PER ODM --
    for (const [odm, items] of Object.entries(groups)) {
        
        // --- A. DASHBOARD SLIDE ---
        let dashSlide = pptx.addSlide({ masterName: "MASTER_SLIDE" });
        
        // Header
        dashSlide.addText(odm + " - Quality Overview", { x:0.5, y:0.3, fontSize:22, color:'0369a1', bold:true });
        dashSlide.addShape(pptx.ShapeType.line, { x:0.5, y:0.7, w:9, h:0, line:'0369a1' });

        // Calculate KPIs
        let totalItems = items.length;
        let avgRate = (items.reduce((acc, curr) => acc + Number(curr.DefectRate), 0) / totalItems).toFixed(1);
        let sorted = [...items].sort((a,b) => b.DefectRate - a.DefectRate);
        let worstModel = sorted[0] ? sorted[0].Model : "N/A";
        let worstRate = sorted[0] ? sorted[0].DefectRate + "%" : "0%";

        // Draw KPI Cards (Shapes + Text)
        // Card 1: Total Models
        dashSlide.addShape(pptx.ShapeType.roundRect, { x:0.5, y:1.0, w:2.8, h:1.2, fill:'0369a1', r:5 });
        dashSlide.addText("MODELS INSPECTED", { x:0.5, y:1.2, w:2.8, fontSize:10, color:'FFFFFF', align:'center' });
        dashSlide.addText(totalItems.toString(), { x:0.5, y:1.5, w:2.8, fontSize:32, color:'FFFFFF', bold:true, align:'center' });

        // Card 2: Avg Defect Rate
        let colorRate = avgRate > 5 ? 'DC3545' : '28A745'; // Red if > 5%, else Green
        dashSlide.addShape(pptx.ShapeType.roundRect, { x:3.6, y:1.0, w:2.8, h:1.2, fill:colorRate, r:5 });
        dashSlide.addText("AVG. DEFECT RATE", { x:3.6, y:1.2, w:2.8, fontSize:10, color:'FFFFFF', align:'center' });
        dashSlide.addText(avgRate + "%", { x:3.6, y:1.5, w:2.8, fontSize:32, color:'FFFFFF', bold:true, align:'center' });

        // Card 3: Top Issue
        dashSlide.addShape(pptx.ShapeType.roundRect, { x:6.7, y:1.0, w:2.8, h:1.2, fill:'6C757D', r:5 });
        dashSlide.addText("HIGHEST DEFECT MODEL", { x:6.7, y:1.2, w:2.8, fontSize:10, color:'FFFFFF', align:'center' });
        dashSlide.addText(worstModel, { x:6.7, y:1.5, w:2.8, fontSize:14, color:'FFFFFF', bold:true, align:'center' });
        dashSlide.addText(worstRate, { x:6.7, y:1.8, w:2.8, fontSize:12, color:'FFFFFF', align:'center' });

        // CHART: Defect Rate per Model
        let chartData = [];
        let chartLabels = [];
        items.forEach(i => {
            chartLabels.push(i.Model);
            chartData.push(Number(i.DefectRate));
        });

        let dataChart = [
            {
                name: "Defect Rate (%)",
                labels: chartLabels,
                values: chartData
            }
        ];

        dashSlide.addChart(pptx.ChartType.bar, dataChart, {
            x: 0.5, y: 2.5, w: 9.0, h: 4.0,
            chartColors: ['0369a1'],
            showValue: true,
            title: { text: "Defect Rate by Model", fontSize: 14, color: '666666' },
            valAxisMaxVal: Math.max(...chartData) + 5
        });

        // --- B. DETAILS TABLE SLIDE ---
        let tableSlide = pptx.addSlide({ masterName: "MASTER_SLIDE" });
        tableSlide.addText(`Detailed Data: ${odm}`, { x:0.5, y:0.3, fontSize:18, color:'333333', bold:true });

        let tableRows = [[
            { text: "Date", options: { bold: true, fill: "F0F2F5" } },
            { text: "Model", options: { bold: true, fill: "F0F2F5" } },
            { text: "Issue / Defect", options: { bold: true, fill: "F0F2F5" } },
            { text: "Rate", options: { bold: true, fill: "F0F2F5" } },
            { text: "RCA", options: { bold: true, fill: "F0F2F5" } }
        ]];

        items.forEach(r => {
            tableRows.push([
                r.Date.replace("'",""),
                r.Model,
                r.DefectDetails,
                { text: r.DefectRate + "%", options: { color: r.DefectRate > 5 ? 'DC3545' : '333333', bold:true } },
                r.RCA
            ]);
        });

        tableSlide.addTable(tableRows, {
            x: 0.5, y: 1.0, w: 9.0,
            fontSize: 10,
            border: { pt: 1, color: 'EEEEEE' },
            autoPage: true // Automatically create new slides if table is too long
        });

        // --- C. IMAGES SLIDE (If Images Exist) ---
        let itemsWithImgs = items.filter(i => i.ImageURLs && i.ImageURLs.length > 5);
        if(itemsWithImgs.length > 0){
            let imgSlide = pptx.addSlide({ masterName: "MASTER_SLIDE" });
            imgSlide.addText(`Visual Evidence: ${odm}`, { x:0.5, y:0.3, fontSize:18, color:'333333', bold:true });

            let x = 0.5, y = 1.0, count = 0;
            itemsWithImgs.forEach(item => {
                 let urls = item.ImageURLs.split(" || ");
                 if(urls[0] && count < 3){
                     // Try adding image (requires valid data URL or public link)
                     try {
                         imgSlide.addImage({ path: urls[0], x: x, y: y, w: 2.8, h: 2.8 });
                         imgSlide.addText(item.Model, { x:x, y:y+2.9, w:2.8, fontSize:10, align:'center' });
                         x += 3.0; count++;
                     } catch(e){}
                 }
            });
        }
    }

    pptx.writeFile({ fileName: `Dashboard_Report_${month}.pptx` });
}

// Initial Load
document.getElementById('saveBtn').onclick = saveRecord;
document.getElementById('clearBtn').onclick = clearForm;
document.getElementById('refreshBtn').onclick = loadData;
loadData();
</script>
</body>
</html>
