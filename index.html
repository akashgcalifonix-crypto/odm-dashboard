<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ODM Major Issues_DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <!-- html2pdf Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
    
    /* --- APP HEADER --- */
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .header-row h2 { color: #0369a1; margin: 0; }
    .app-logo { height: 50px; object-fit: contain; }

    /* --- FORM STYLES --- */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { font-weight: bold; font-size: 12px; color: #555; display: block; margin-bottom: 5px; }
    input, textarea, select { padding: 9px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background: #fafafa; }
    input:focus, textarea:focus { border-color: #0369a1; background: #fff; outline: none; }
    
    .btn { background: #0369a1; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn:hover { background: #025686; transform: translateY(-1px); }
    .btn.secondary { background: #6b7280; }
    .btn.danger { background: #dc3545; }
    .btn.success { background: #28a745; }
    
    /* --- DATA TABLE --- */
    table.data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; font-size: 13px; border-radius: 8px; overflow: hidden; }
    .data-table th, .data-table td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; vertical-align: middle; }
    .data-table th { background: #0369a1; color: white; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
    .data-table tr:hover { background: #f9fbfd; }
    
    .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; transition: transform 0.2s; }
    .thumb:hover { transform: scale(1.5); }

    /* --- MODAL --- */
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal-content { background:white; width: 850px; max-width: 95%; height: 90vh; border-radius:8px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 8px 8px 0 0; }
    .modal-body { padding: 30px; overflow-y: auto; flex: 1; background: #525659; /* PDF viewer bg look */ display: flex; justify-content: center; }
    .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; background: #fff; border-radius: 0 0 8px 8px;}

    /* --- NEW ATTRACTIVE REPORT STYLES --- */
    .report-container { background: white; width: 100%; max-width: 210mm; min-height: 297mm; padding: 40px; box-sizing: border-box; box-shadow: 0 0 15px rgba(0,0,0,0.5); position: relative; }
    
    /* Report Header */
    .rep-head-wrap { border-bottom: 4px solid #0369a1; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
    .rep-logo { height: 70px; object-fit: contain; }
    .rep-title-box { text-align: right; }
    .rep-title-box h1 { margin: 0; color: #0369a1; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
    .rep-title-box p { margin: 5px 0 0; color: #666; font-size: 12px; }

    /* Info Grid (Cards) */
    .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
    .info-card { background: #f8fbff; border: 1px solid #e1e8f0; padding: 15px; border-radius: 6px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px dashed #e0e0e0; padding-bottom: 4px; }
    .info-row:last-child { border: none; margin: 0; padding: 0; }
    .info-label { color: #666; font-weight: 600; }
    .info-val { font-weight: bold; color: #333; }

    /* Rate Box */
    .rate-box { background: #0369a1; color: white; text-align: center; padding: 15px; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; }
    .rate-title { font-size: 11px; text-transform: uppercase; opacity: 0.9; }
    .rate-val { font-size: 28px; font-weight: bold; margin-top: 5px; }

    /* Details Section */
    .detail-section { margin-bottom: 30px; }
    .sec-head { background: #eef2f6; color: #0369a1; padding: 8px 12px; font-weight: bold; font-size: 14px; border-left: 4px solid #0369a1; margin-bottom: 10px; }
    .detail-text { font-size: 13px; line-height: 1.6; color: #333; padding: 0 10px; white-space: pre-wrap; text-align: justify; }

    /* Images */
    .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
    .report-img-wrap { border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: #fff; text-align: center; }
    .report-img { width: 100%; height: 180px; object-fit: contain; }
    
    /* Footer */
    .rep-footer { margin-top: 50px; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between; font-size: 11px; color: #999; }
  </style>
</head>

<body>

<div class="card">
  <!-- LOGO IN APP HEADER -->
  <div class="header-row">
      <h2>ODM Major Issues</h2>
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="app-logo" alt="Logo">
  </div>

  <input type="hidden" id="editRowIndex">

  <div class="form-grid">
      <div><label>Date</label><input id="date" type="date"></div>
      <div><label>ODM</label><input id="odm"></div>
      <div><label>Model</label><input id="model"></div>
      <div><label>PO Number</label><input id="po"></div>
  </div>

  <div class="form-grid">
      <div><label>Item Name</label><input id="item"></div>
      <div><label>Defect Rate %</label><input id="defectRate" type="number" placeholder="%"></div>
      <div><label>Prepared By</label><input id="preparedBy"></div>
      <div><label>Upload Images (Max 3)</label><input id="images" type="file" accept="image/*" multiple></div>
  </div>

  <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
      <div><label>Defect Details</label><textarea id="defectDetails" rows="3"></textarea></div>
      <div><label>RCA / Remarks</label><textarea id="rca" rows="3"></textarea></div>
  </div>

  <div style="margin-top:20px;">
      <button id="saveBtn" class="btn">Save Record</button>
      <button id="clearBtn" class="btn secondary">Clear Form</button>
      <button id="refreshBtn" class="btn secondary" style="float:right">Refresh List</button>
  </div>

  <table id="dataTable" class="data-table">
    <thead>
      <tr><th>Date</th><th>Model</th><th>Defect</th><th>Rate%</th><th>RCA</th><th>Image</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- PROFESSIONAL PREVIEW MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0; color:#333;">üìÑ Report Preview</h3>
      <button onclick="closeModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    
    <div class="modal-body">
      <!-- REPORT AREA START -->
      <div id="printArea" class="report-container">
          
          <!-- Header -->
          <div class="rep-head-wrap">
              <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="rep-logo" alt="Logo" crossorigin="anonymous">
              <div class="rep-title-box">
                  <h1>Defect Analysis Report</h1>
                  <p>Quality Assurance Dept.</p>
                  <p id="rep_gen_date"></p>
              </div>
          </div>

          <!-- Info Grid -->
          <div class="info-section">
              <!-- Left Info -->
              <div class="info-card">
                  <div class="info-row"><span class="info-label">ODM Name</span> <span id="rep_odm" class="info-val"></span></div>
                  <div class="info-row"><span class="info-label">Model No.</span> <span id="rep_model" class="info-val"></span></div>
                  <div class="info-row"><span class="info-label">Item Name</span> <span id="rep_item" class="info-val"></span></div>
                  <div class="info-row"><span class="info-label">PO Number</span> <span id="rep_po" class="info-val"></span></div>
              </div>
              
              <!-- Right Info / Stats -->
              <div style="display:grid; grid-template-columns: 1fr 100px; gap:10px;">
                  <div class="info-card">
                      <div class="info-row"><span class="info-label">Report Date</span> <span id="rep_date" class="info-val"></span></div>
                      <div class="info-row"><span class="info-label">Prepared By</span> <span id="rep_prep" class="info-val"></span></div>
                      <div class="info-row"><span class="info-label">Status</span> <span class="info-val" style="color:red">Critical</span></div>
                  </div>
                  <div class="rate-box">
                      <div class="rate-title">Defect Rate</div>
                      <div id="rep_rate" class="rate-val"></div>
                  </div>
              </div>
          </div>

          <!-- Details -->
          <div class="detail-section">
              <div class="sec-head">1. Defect Description & Observation</div>
              <div id="rep_desc" class="detail-text"></div>
          </div>

          <div class="detail-section">
              <div class="sec-head">2. Root Cause Analysis (RCA) / Remarks</div>
              <div id="rep_rca" class="detail-text"></div>
          </div>

          <!-- Images -->
          <div class="detail-section" style="margin-top:40px;">
              <div class="sec-head">3. Visual Evidence</div>
              <div id="rep_images" class="img-grid"></div>
          </div>

          <!-- Footer -->
          <div class="rep-footer">
              <span>Authorized Signature: ___________________</span>
              <span>Generated via ODM Tracker</span>
          </div>

      </div>
      <!-- REPORT AREA END -->
    </div>

    <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal()">Close Preview</button>
        <button class="btn success" onclick="downloadPDF()">‚¨á Download PDF Report</button>
    </div>
  </div>
</div>

<script>
// ‚ö†Ô∏è YAHAN APNA SCRIPT URL PASTE KAREIN
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGCDn3USDWCByX5a-rgiZDkX-YwdfH4y1bd6_PgpLs-ZXgLo9FG5eboPSt4zKI8TfEcA/exec";

let allData = [];

// --- UTILS ---
function escapeHtml(s){ return s ? String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }

function readFilesAndCompress(files) {
  return Promise.all([...files].map(file => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        if(w > 800) { h *= 800/w; w = 800; }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        resolve({ name: file.name, data: canvas.toDataURL('image/jpeg', 0.6) });
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  })));
}

// --- SAVE FUNCTION ---
async function saveRecord(){
  const btn = document.getElementById('saveBtn');
  btn.innerText = "Uploading..."; btn.disabled = true;

  const fileInput = document.getElementById('images');
  let imgs = [];
  if(fileInput.files.length > 0) {
      imgs = await readFilesAndCompress(fileInput.files);
  }

  const rowIndex = document.getElementById('editRowIndex').value;
  const action = rowIndex ? "update" : "create";

  // Edit mode: Keep old images if no new ones are selected
  if(action === "update" && imgs.length === 0){
      let oldRow = allData.find(r => r._rowIndex == rowIndex);
      if(oldRow && oldRow.ImageURLs) {
          imgs = oldRow.ImageURLs.split(" || ").map(url => ({ data: url }));
      }
  }

  let record = {
    date: document.getElementById('date').value,
    odm: document.getElementById('odm').value,
    model: document.getElementById('model').value,
    po: document.getElementById('po').value,
    item: document.getElementById('item').value,
    defectDetails: document.getElementById('defectDetails').value,
    defectRate: document.getElementById('defectRate').value,
    rca: document.getElementById('rca').value,
    remarks: "", 
    preparedBy: document.getElementById('preparedBy').value,
    images: imgs 
  };

  try {
      let res = await fetch(SCRIPT_URL, { method:"POST", body: JSON.stringify({ action, record, rowIndex }) });
      let j = await res.json();
      if(j.status==="success"){
        alert("‚úÖ Saved Successfully!");
        clearForm();
        loadData();
      } else { alert("Failed: "+j.message); }
  } catch(e){ console.error(e); alert("Error saving."); }
  
  btn.innerText = "Save Record"; btn.disabled = false;
}

function clearForm(){
  document.querySelectorAll('input, textarea').forEach(el => el.value = "");
  document.getElementById('saveBtn').innerText = "Save Record";
  document.getElementById('editRowIndex').value = "";
}

// --- LOAD DATA ---
async function loadData(){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px;'>Loading Data...</td></tr>";
  try {
      let res = await fetch(SCRIPT_URL);
      let j = await res.json();
      allData = j.rows;
      renderTable(j.rows);
  } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='7'>Error Loading</td></tr>"; }
}

function renderTable(rows){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  if(rows.length === 0) { tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>No Records Found</td></tr>"; return; }
  
  rows.forEach((r) => {
    let imgList = (r.ImageURLs || "").split(" || ").filter(Boolean);
    let thumb = imgList.length ? `<img src="${imgList[0]}" class="thumb" onclick='openPreview(${JSON.stringify(r)})'>` : '<span style="color:#ccc; font-size:11px;">No Img</span>';
    let cleanDate = r.Date ? r.Date.replace("'", "") : "";

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${cleanDate}</td>
      <td><strong>${escapeHtml(r.Model)}</strong></td>
      <td>${escapeHtml(r.DefectDetails)}</td>
      <td style="color:${r.DefectRate > 5 ? 'red' : 'green'}; font-weight:bold;">${escapeHtml(r.DefectRate)}%</td>
      <td>${escapeHtml(r.RCA)}</td>
      <td>${thumb}</td>
      <td>
        <button class="btn success" style="padding:4px 8px; font-size:12px;" onclick='openPreview(${JSON.stringify(r)})'>PDF</button>
        <button class="btn secondary" style="padding:4px 8px; font-size:12px;" onclick="editRecord(${r._rowIndex})">‚úé</button>
        <button class="btn danger" style="padding:4px 8px; font-size:12px;" onclick="deleteRecord(${r._rowIndex})">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editRecord(rowIndex){
  let r = allData.find(x => x._rowIndex == rowIndex);
  if(!r) return;
  document.getElementById('date').value = r.Date.replace("'", "");
  document.getElementById('odm').value = r.ODM;
  document.getElementById('model').value = r.Model;
  document.getElementById('po').value = r.PO;
  document.getElementById('item').value = r.Item;
  document.getElementById('defectDetails').value = r.DefectDetails;
  document.getElementById('defectRate').value = r.DefectRate;
  document.getElementById('rca').value = r.RCA;
  document.getElementById('preparedBy').value = r.PreparedBy;
  document.getElementById('editRowIndex').value = rowIndex;
  document.getElementById('saveBtn').innerText = "Update Record";
  window.scrollTo(0,0);
}

async function deleteRecord(rowIndex){
  if(!confirm("Are you sure you want to delete this record?")) return;
  await fetch(SCRIPT_URL,{ method:"POST", body: JSON.stringify({action:"delete", rowIndex}) });
  loadData();
}

// --- NEW PREVIEW LOGIC ---
function openPreview(r){
    // Text Data
    document.getElementById('rep_date').innerText = (r.Date || "").replace("'", "") || "-";
    document.getElementById('rep_gen_date').innerText = "Gen: " + new Date().toLocaleDateString();
    document.getElementById('rep_prep').innerText = r.PreparedBy || "N/A";
    document.getElementById('rep_odm').innerText = r.ODM || "N/A";
    document.getElementById('rep_model').innerText = r.Model || "N/A";
    document.getElementById('rep_po').innerText = r.PO || "N/A";
    document.getElementById('rep_item').innerText = r.Item || "N/A";
    document.getElementById('rep_desc').innerText = r.DefectDetails || "No details provided.";
    document.getElementById('rep_rate').innerText = (r.DefectRate || 0) + "%";
    document.getElementById('rep_rca').innerText = r.RCA || "No RCA provided.";

    // Images
    const imgContainer = document.getElementById('rep_images');
    imgContainer.innerHTML = "";
    let imgs = (r.ImageURLs || "").split(" || ").filter(Boolean);
    
    if(imgs.length > 0){
        imgs.forEach(url => {
            let div = document.createElement('div');
            div.className = 'report-img-wrap';
            let img = document.createElement('img');
            img.crossOrigin = "Anonymous"; // Crucial for PDF
            img.src = url;
            img.className = 'report-img';
            img.onerror = function() { this.style.display='none'; };
            div.appendChild(img);
            imgContainer.appendChild(div);
        });
    } else { 
        imgContainer.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:#ccc;'>No images attached.</p>"; 
    }
    
    document.getElementById('modal').style.display = 'flex';
}

function closeModal(){ document.getElementById('modal').style.display = 'none'; }

function downloadPDF(){
    const element = document.getElementById('printArea');
    const modelName = document.getElementById('rep_model').innerText;
    
    // Better PDF Settings
    const opt = {
        margin: 0, 
        filename: `RCA_Report_${modelName}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}

document.getElementById('saveBtn').onclick = saveRecord;
document.getElementById('clearBtn').onclick = clearForm;
document.getElementById('refreshBtn').onclick = loadData;
loadData();
</script>
</body>
</html>

